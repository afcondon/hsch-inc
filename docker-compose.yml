# Polyglot PureScript - Full Stack
#
# Runs all showcases behind the Scuppered Ligature edge layer
#
# Usage:
#   docker-compose build        # Build all images
#   docker-compose up -d        # Start all services
#   docker-compose logs -f      # Follow logs
#   docker-compose down         # Stop all services
#
# Routes (via edge layer at port 80):
#   /           - Polyglot PureScript home (website)
#   /website    - PSD3 documentation (alias)
#   /ee         - Embedding Explorer (UI at /ee, API at /ee/api)
#   /ge         - Grid Explorer (UI at /ge, API at /ge/api)
#   /tidal      - Tidal Editor (UI at /tidal, API at /tidal/api)
#   /code       - Minard Code Cartography (UI at /code, API at /code/api)
#   /sankey     - Sankey Editor
#   /wasm       - WASM Force Demo
#   /psd3/*     - Library documentation sites

services:
  # ============================================================
  # EDGE LAYER (Lua/Nginx)
  # ============================================================
  edge:
    build:
      context: ./showcases/scuppered-ligature
      dockerfile: docker/Dockerfile
    ports:
      - "80:80"
    depends_on:
      - website
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/edge/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # CORE SERVICES
  # ============================================================
  website:
    build:
      context: ./site/website
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # TILTED RADIO (Erlang + JavaScript)
  # ============================================================
  tidal-backend:
    build:
      context: ./showcases/psd3-tilted-radio/purerl-tidal
    ports:
      - "8083:8083"
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8083/"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3

  tidal-frontend:
    build:
      context: ./showcases/psd3-tilted-radio/purescript-psd3-tidal
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # HYPO-PUNTER (Python + JavaScript)
  # ============================================================
  ee-backend:
    build:
      context: ./showcases/hypo-punter/ee-server
    ports:
      - "5081:5081"
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5081/')"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3

  ee-frontend:
    build:
      context: ./showcases/hypo-punter/ee-website
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  ge-backend:
    build:
      context: ./showcases/hypo-punter/ge-server
    ports:
      - "5082:5082"
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5082/')"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3

  ge-frontend:
    build:
      context: ./showcases/hypo-punter/ge-website
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # ARID KEYSTONE (JS only)
  # ============================================================
  sankey:
    build:
      context: ./showcases/psd3-arid-keystone
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # MINARD - Code Cartography (Node.js + JavaScript)
  # ============================================================
  minard-backend:
    build:
      context: ./apps/minard
      dockerfile: server/Dockerfile
    ports:
      - "3000:3000"
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3

  minard-frontend:
    build:
      context: ./apps/minard/frontend
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # WASM FORCE DEMO (Rust/WASM + JavaScript)
  # ============================================================
  wasm-demo:
    build:
      context: ./showcases/wasm-force-demo
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # ADDITIONAL PURESCRIPT SHOWCASES
  # ============================================================
  optics:
    build:
      context: ./showcases/emptier-coinage
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  zoo:
    build:
      context: ./showcases/psd3-prim-zoo-mosh
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  honeycomb:
    build:
      context: ./showcases/psd3-honeycomb
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  anscombe:
    build:
      context: ./visualisation libraries/psd3-anscombe-quartet
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  layouts:
    build:
      context: ./showcases/allergy-outlay
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  hylograph:
    build:
      context: ./showcases/hylograph-app
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  site-explorer:
    build:
      context: ./apps/minard/site-explorer
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # LIBRARY DOCUMENTATION SITES
  # ============================================================
  lib-selection:
    build:
      context: ./site/lib-selection
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  lib-simulation:
    build:
      context: ./site/lib-simulation
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  lib-layout:
    build:
      context: ./site/lib-layout
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  lib-graph:
    build:
      context: ./site/lib-graph
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  lib-music:
    build:
      context: ./site/lib-music
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

networks:
  polyglot:
    driver: bridge
