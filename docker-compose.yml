# Polyglot PureScript - Full Stack
#
# Runs all showcases behind the Scuppered Ligature edge layer
#
# Usage:
#   docker-compose build        # Build all images
#   docker-compose up -d        # Start all services
#   docker-compose logs -f      # Follow logs
#   docker-compose down         # Stop all services
#
# Routes (via edge layer at port 80):
#   /           - Polyglot PureScript home (website)
#   /website    - PSD3 documentation (alias)
#   /ee         - Embedding Explorer (UI at /ee, API at /ee/api)
#   /ge         - Grid Explorer (UI at /ge, API at /ge/api)
#   /tidal      - Tidal Editor (UI at /tidal, API at /tidal/api)
#   /code       - Code Explorer (UI at /code, API at /code/api)
#   /sankey     - Sankey Editor
#   /wasm       - WASM Force Demo

services:
  # ============================================================
  # EDGE LAYER (Lua/Nginx)
  # ============================================================
  edge:
    build:
      context: ./showcases/scuppered-ligature
      dockerfile: docker/Dockerfile
    ports:
      - "80:80"
    depends_on:
      - website
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/edge/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # CORE SERVICES
  # ============================================================
  website:
    build:
      context: ./site/website
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # TILTED RADIO (Erlang + JavaScript)
  # ============================================================
  tidal-backend:
    build:
      context: ./showcases/psd3-tilted-radio/purerl-tidal
    ports:
      - "8083:8083"
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8083/"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3

  tidal-frontend:
    build:
      context: ./showcases/psd3-tilted-radio/purescript-psd3-tidal
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # HYPO-PUNTER (Python + JavaScript)
  # ============================================================
  ee-backend:
    build:
      context: ./showcases/hypo-punter/ee-server
    ports:
      - "5081:5081"
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5081/')"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3

  ee-frontend:
    build:
      context: ./showcases/hypo-punter/ee-website
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  ge-backend:
    build:
      context: ./showcases/hypo-punter/ge-server
    ports:
      - "5082:5082"
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5082/')"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3

  ge-frontend:
    build:
      context: ./showcases/hypo-punter/ge-website
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # ARID KEYSTONE (JS only)
  # ============================================================
  sankey:
    build:
      context: ./showcases/psd3-arid-keystone
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # CORRODE EXPEL (Node.js + JavaScript)
  # ============================================================
  ce-backend:
    build:
      context: ./showcases/corrode-expel
      dockerfile: ce-server/Dockerfile
    ports:
      - "3000:3000"
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3

  ce-frontend:
    build:
      context: ./showcases/corrode-expel/ce2-website
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================================
  # WASM FORCE DEMO (Rust/WASM + JavaScript)
  # ============================================================
  wasm-demo:
    build:
      context: ./showcases/wasm-force-demo
    networks:
      - polyglot
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

networks:
  polyglot:
    driver: bridge
