# Tour Redesign: Scrollytelling with Progressive AST Revelation

## Core Concept

A scrollytelling tour that progressively builds visualizations while showing the underlying tree structure. The key insight: **everything is trees** - the code (AST), the visualization description (TreeAPI), and often the data itself.

## Layout

```
+------------------------------------------+
|              FIXED PANEL                 |
|                                          |
|         [Live Visualization]             |
|                                          |
|   Updates as user scrolls through steps  |
+------------------------------------------+
|           SCROLLING PANEL                |
|                                          |
|  Step 1: Empty SVG                       |
|  ┌─────────────────────────────────────┐ |
|  │ Code fragment    │  AST tree viz    │ |
|  │                  │      ○ SVG       │ |
|  └─────────────────────────────────────┘ |
|                                          |
|  Step 2: Add a group                     |
|  ┌─────────────────────────────────────┐ |
|  │ Code fragment    │  AST tree viz    │ |
|  │                  │      ○ SVG       │ |
|  │                  │      └─○ Group   │ |
|  └─────────────────────────────────────┘ |
|                                          |
|  Step 3: Add circles with data...        |
|                                          |
+------------------------------------------+
```

## Narrative Arc: "From Nothing to Insight"

### Act 1: The Simplest Possible Thing (3 circles)

1. **Empty canvas** - Just an SVG element
   - Code: `T.elem SVG [width 400, height 200]`
   - AST: Single node

2. **Add a container** - A group for organization
   - Code: `...withChild (T.named Group "circles" [])`
   - AST: Two nodes connected

3. **Add data** - The data join appears
   - Code: `joinData "circles" "circle" ["a","b","c"] \d -> ...`
   - AST: Join node with orange color (different from structural nodes)

4. **Position the circles** - Attributes from data
   - Code: `cx (30.0 + index * 40.0)`
   - AST: Attribute nodes appear

5. **The complete picture** - Three circles
   - Full code visible
   - Full AST tree visible
   - Visualization shows three circles

**Insight moment**: The code IS a tree. We just built a tree to describe circles.

### Act 2: Adding Complexity (Bar Chart)

6. **Same pattern, different data** - Numbers instead of letters
   - Show how the structure is identical
   - Only the data and attributes differ

7. **Scales appear** - Mapping data to pixels
   - New concept: scales as functions
   - AST shows the same structure

8. **Axes join** - Labels are also data joins
   - Reveal: axes are just another data join
   - The tick marks follow the same pattern

### Act 3: Hierarchies (The Meta Moment)

9. **Tree data** - A hierarchy of nodes
   - Show the flare.json or similar tree data
   - "This data IS a tree"

10. **Tree layout** - Computing positions
    - The layout algorithm assigns x,y to each node
    - Still just data transformation

11. **Tree visualization** - Rendering the tree
    - Links and nodes, just like circles before
    - **But wait**: look at the AST panel...

12. **The Revelation** - Trees all the way down
    - The visualization shows a tree
    - The AST of that code is ALSO a tree
    - Place them side by side
    - "The structure of the code mirrors the structure of the data"
    - **This is what makes PSD3 special**: the grammar IS the visualization

### Act 4: The Interpreters (Same Tree, Many Forms)

13. **Switch interpreters** - Same code, different output
    - D3/DOM interpreter → actual visualization
    - Mermaid interpreter → flowchart syntax
    - English interpreter → prose description
    - AST interpreter → the tree we've been seeing

14. **Full circle** - Understanding through structure
    - The tour itself was built with these tools
    - The AST diagrams were generated by PSD3
    - Self-describing, self-hosting

## Technical Implementation

### Halogen Component Structure

```purescript
type State =
  { currentStep :: Int
  , visibleSteps :: Array Int  -- For intersection observer
  , showCode :: Boolean
  , showAST :: Boolean
  }

data Action
  = Initialize
  | StepBecameVisible Int
  | StepBecameHidden Int
  | ToggleCode
  | ToggleAST
```

### Step Data Structure

```purescript
type TourStep =
  { id :: Int
  , title :: String
  , narrative :: String           -- The story text
  , codeFragment :: String        -- PureScript code to show
  , astTree :: T.Tree Unit        -- AST visualization tree
  , visualization :: T.Tree Unit  -- The actual viz at this step
  , insight :: Maybe String       -- Optional "aha" callout
  }
```

### Intersection Observer for Scroll Detection

```javascript
// FFI for scroll position detection
export const observeSteps = (callback) => () => {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        callback(entry.target.dataset.step)();
      }
    });
  }, { threshold: 0.5 });

  document.querySelectorAll('.tour-step').forEach(el => {
    observer.observe(el);
  });

  return observer;
};
```

### CSS Layout

```css
.tour-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  height: 100vh;
}

.tour-fixed-panel {
  position: sticky;
  top: 0;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--surface-elevated);
}

.tour-scroll-panel {
  overflow-y: auto;
  padding: var(--space-8);
}

.tour-step {
  min-height: 80vh;  /* Ensures good scroll distance between steps */
  padding: var(--space-6);
  margin-bottom: var(--space-8);
}

.tour-step-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-4);
}

.tour-code {
  font-family: var(--font-mono);
  background: var(--surface-code);
}

.tour-ast {
  /* SVG container for AST tree visualization */
}
```

## Step Definitions

### Step 1: Empty SVG
```purescript
step1 :: TourStep
step1 =
  { id: 1
  , title: "The Beginning: An Empty Canvas"
  , narrative: "Every visualization starts here. An SVG element is just a container - a blank canvas waiting for content."
  , codeFragment: """
      T.elem SVG
        [ width 400
        , height 200
        ]
    """
  , astTree: -- Single SVG node
  , visualization: -- Empty 400x200 SVG
  , insight: Nothing
  }
```

### Step 5: Three Circles Complete
```purescript
step5 :: TourStep
step5 =
  { id: 5
  , title: "The Complete Picture"
  , narrative: "Three pieces of data became three circles. But look at the AST panel - the code itself is a tree structure."
  , codeFragment: -- Full three circles code
  , astTree: -- Full AST tree
  , visualization: -- Three circles
  , insight: Just "The code IS a tree. We built a tree to describe circles."
  }
```

### Step 12: Trees All The Way Down
```purescript
step12 :: TourStep
step12 =
  { id: 12
  , title: "The Revelation: Trees All The Way Down"
  , narrative: "Look at both panels. The visualization shows a tree. The AST of that code is also a tree. The structure of the code mirrors the structure of the data."
  , codeFragment: -- Tree visualization code
  , astTree: -- AST of tree viz (also a tree!)
  , visualization: -- Tree diagram
  , insight: Just "This is what makes PSD3 special: the grammar IS the visualization."
  }
```

## Migration Path

1. **Phase 1**: Create new TourScrolly component with infrastructure
2. **Phase 2**: Implement Act 1 (three circles) as proof of concept
3. **Phase 3**: Add remaining acts
4. **Phase 4**: Replace TourIndex links to point to new tour
5. **Phase 5**: Archive or remove old tour pages

## Open Questions

- Should the fixed panel show BOTH the viz AND a mini AST, or just the viz?
- How to handle mobile (no side-by-side)?
- Should steps have explicit "next" buttons or pure scroll?
- Timing of AST tree growth animation?

## References

- `TourInterpreters.purs` - existing AST visualization code
- `UnderstandingGrammar.purs` - grammar explanation
- `TreeBuilder3/` - tree builder with AST capabilities
- Scrollytelling examples: pudding.cool, nytimes interactives
