# Worklog: 2026-02-03

## Session Focus
Implement Docker Compose profiles and focus management system to reduce memory usage and prevent Claude context loss from causing inconsistent deployment patterns.

## Accomplished

### Docker Compose Profiles
- Added profiles to all ~20 services in `docker-compose.yml`
- Profiles: `core`, `minard`, `tidal`, `hypo`, `sankey`, `wasm`, `libs`, `showcases`, `full`
- Each profile includes edge + website as base, plus relevant services

### Focus Management System
- Created `.claude-focus` file mechanism for session scope
- Added `make focus-<profile>` targets that:
  1. Update `.claude-focus` with profile info
  2. Stop all containers
  3. Start only the profile's containers
- Added `make focus-status` and `make focus-stop` utilities

### CLAUDE.md Updates
- Added "Focus Management (MANDATORY)" section
- Added "Absolute Prohibitions (MANDATORY)" section with hard rules:
  - NO ad-hoc HTTP servers
  - NO custom ports (use port 80 via edge)
  - NO deployment without reading focus file
  - NO full stack when focus is set

### Skill Updates
- Updated `/build` and `/deploy` skills with "Step 0: Check Focus"
- Skills now require reading `.claude-focus` before any operation

### Nginx Dynamic Resolution Fix
- Removed static `upstream` blocks from `showcases/scuppered-ligature/nginx.conf`
- Edge now uses dynamic DNS resolution via Docker's internal resolver
- Nginx starts successfully even when backend containers aren't running
- Missing services return 502 instead of preventing startup

## Explored But Not Pursued

- **Apple Containers**: Researched as Docker alternative for memory efficiency. Not viable yet - no docker-compose support, networking broken on macOS 15, requires macOS 26 for full functionality. Revisit when macOS 26 ships.

- **OrbStack**: Identified as potential middle-ground (drop-in Docker replacement with better memory management). User chose to stick with Docker for now and leverage MacMini for heavy workloads.

- **Separate edge configs per profile**: Considered having different nginx configs for each profile. Rejected in favor of dynamic resolution which is simpler and keeps URLs consistent.

## Parking Lot

- Consider moving more services to MacMini permanently to reduce local memory pressure
- OrbStack evaluation if Docker memory issues persist
- Apple Containers re-evaluation when macOS 26 releases

## Decisions Made

- **Dynamic nginx resolution over static upstreams**: Removes startup dependency on all backends, allows partial stack operation. Trade-off: 502 errors for unavailable services (acceptable - informative).

- **Focus file as structural constraint**: Rather than relying on documentation Claude might forget, the focus file creates a checkpoint Claude must read. Combined with skill updates, this is enforcement rather than guidance.

- **Profiles include edge + website always**: Every profile needs the router (edge) and home page (website) as base infrastructure. Keeps URLs consistent across profiles.

## Reports Generated

- `docs/kb/howto/focus-management.md` - Guide to using the focus system

### Deployment Target Convention (added later in session)
- Added `target: local` or `target: remote` to focus file
- Most profiles target local Docker
- `focus-full` targets MacMini (remote) - full stack too heavy for local
- Updated `/deploy` skill to read target and default appropriately
- Pattern: build on MBP, deploy to MacMini for full stack testing

## Next Session Setup

- Focus system is operational: `make focus-minard` tested and working
- Other Claude session successfully built and deployed minard using the new system
- Docker Desktop restarted to reclaim memory (was running since Jan 12)
- To use: run `make focus-<profile>` before starting Claude session
- For full stack work: `make focus-full` then build locally, deploy to MacMini
