# Worklog: 2026-01-25

## Session Focus
Investigate intermittent `unsafeCrashWith` crashes in applications using psd3-simulation, trace to root causes, create tests, and document fix plan.

## Accomplished

- **Identified two independent crash bugs**:
  1. **Links.purs**: `swizzleLinks` uses array position as lookup key, but link.source/target are semantic indices (node.index field). When nodes array is filtered, array positions ≠ node.index values → crash
  2. **Operations.purs**: BoundSelection constructed with elements from actual renders but data from original selection. If rendering partially fails, `elements.length < data.length` → crash when iterating

- **Created comprehensive test suite** (`test/Test/ForceEngine/LinksSpec.purs`):
  - 11 test cases covering happy paths, edge cases, and FFI operations
  - Documents the `swizzleLinks` bug (crash test disabled to not halt test suite)
  - Verifies `swizzleLinksByIndex` handles filtered node subsets safely
  - Tests IntSet, IntMap, StringSet FFI operations
  - All tests pass via `spago test`

- **Catalogued all `unsafeCrashWith` patterns** across psd3-simulation and psd3-selection:
  - Links.purs line 117: array index out of bounds
  - Operations.purs lines 2582, 2618: index out of bounds in renderTemplates
  - Operations.purs lines 320-322: contradictory head/unsafeIndex logic
  - Operations.purs lines 1896, 3128, 3149, 3184: empty parentElements crashes
  - Plus ~10 more in D3 transition paths (AnimatedAttr/AnimatedCompound errors)

- **Created STP fix plan** (`docs/kb/plans/array-safety-fixes.md`):
  - Situation: Two classes of array index bugs causing intermittent crashes
  - Target: Elements/data stay paired, invariants checked at construction
  - Proposal: Smart constructor for BoundSelection, refactor render flow to pair elements with data

- **Updated KB index** with new plan document (now 23 plans)

## Explored But Not Pursued

- **Crash test that actually crashes**: Initially wrote a test that triggered the `swizzleLinks` crash, but `Effect.Exception.try` can't catch synchronous pure function crashes. Converted to documentation of the known bug instead.

- **Warning on empty DOM selection**: Considered failing when `joinDataWithKey` returns no existing elements, but realized empty is legitimate in GUP (all data could be new → empty update selection).

## Parking Lot

- Lower-priority `unsafeCrashWith` patterns in Operations.purs (lines 320-322 contradictory logic, empty parentElements handling)
- Consider using `NonEmptyArray` at type level for selections that must have elements
- DOM mocking for Operations.purs testing (currently browser-only)

## Decisions Made

- **The real invariant is length matching, not non-emptiness**: Empty enter/update/exit selections are legitimate. The bug is when `elements.length ≠ data.length` within a BoundSelection.

- **Two separate fixes needed**: Links.purs and Operations.purs bugs have different root causes and require independent fixes.

- **`swizzleLinksByIndex` is the safe pattern**: It already exists and uses Map lookup by node.index field. The "forked" code mentioned by user was actually the correct solution.

- **Fix order**: Links documentation first (simple), then Operations.purs smart constructor (catches violations), then refactor render flow (prevents violations).

## Reports Generated

- `docs/kb/plans/array-safety-fixes.md` - Comprehensive STP plan for both fixes

## Next Session Setup

**To implement the fixes, start with:**

1. **Links.purs** - Add documentation warning that `swizzleLinks` is unsafe with filtered nodes, recommend `swizzleLinksByIndex`

2. **Operations.purs** - Add `mkBoundSelection` smart constructor:
   ```purescript
   mkBoundSelection elements dataArray indices doc =
     if Array.length elements /= Array.length dataArray
     then unsafeCrashWith $ "BoundSelection invariant violated: ..."
     else Selection $ BoundSelection { ... }
   ```

3. **Operations.purs** - Refactor render flow to keep elements/data paired (extract datum alongside element, not from original selection)

**Key files:**
- `visualisation libraries/purescript-psd3-simulation/src/PSD3/ForceEngine/Links.purs`
- `visualisation libraries/purescript-psd3-selection/src/PSD3/Internal/Selection/Operations.purs`
- `test/Test/ForceEngine/LinksSpec.purs` (update when fix is implemented)

**Reference:**
- Plan: `docs/kb/plans/array-safety-fixes.md`
- Tests: Run `cd "visualisation libraries/purescript-psd3-simulation" && spago test`

---

## Session 2: CE2 Phase 7 Cleanup

### Session Focus
Complete Phase 7 of the CE2 refactor plan: remove dead visualization components and clean up the codebase.

### Accomplished

- **Fixed PkgModuleBeeswarm not rendering**: Root cause was DOM element ID collision (`#module-beeswarm-nodes` used by multiple views) plus infinite loop in `computeModuleTopoLayers` when cyclic imports exist. Fixed with Kahn's algorithm for topo sort and unique IDs.

- **Created CE2.Containers module**: Type-safe central registry for all DOM element IDs, preventing the "stringly-typed selector" class of bugs. Provides `ElementId` (for Halogen `HP.id`) and `Selector` (for D3, with `#` prefix) types.

- **Migrated all visualization components to Containers**: Updated 8 files to use `C.*` constants instead of hardcoded string selectors:
  - SceneCoordinator, GalaxyBeeswarmViz, BubblePackBeeswarmViz, CirclePackViz
  - ModuleBeeswarmViz, ModuleBubblePackViz (Component layer)
  - BubblePackBeeswarm, ModuleBubblePack (Viz layer)

- **Identified and removed 43 dead files**:
  - Traced import graph from Main.purs → AppShell → SceneCoordinator
  - Found legacy App.purs and ViewCoordinator.purs completely unused
  - All `*Viz` wrapper components only imported by dead coordinators
  - Entire Triptych/ folder, TreeView, ForceGraph, etc. - all dead

- **Two-commit cleanup strategy**:
  - `77e36cf`: Archive checkpoint (files moved to `_archive/`)
  - `8bd5d6a`: Permanent deletion (14,355 lines removed)

### Final Codebase Structure

**19 source files remain (down from 58):**
```
ce2-website/src/
├── Main.purs, Scene.purs, Types.purs, Color.purs, Containers.purs
├── Component/
│   ├── AppShell.purs
│   ├── SceneCoordinator.purs
│   ├── GalaxyBeeswarmViz.purs
│   ├── BubblePackBeeswarmViz.purs
│   └── CirclePackViz.purs
├── Data/
│   ├── Loader.purs
│   └── Filter.purs
└── Viz/
    ├── PackageSetTreemap.purs, ModuleTreemap.purs
    ├── PackageSetBeeswarm.purs, ModuleBeeswarm.purs
    ├── BubblePackBeeswarm.purs, ModuleBubblePack.purs
    └── ScaleTransition.purs
```

### Explored But Not Pursued

- **Phantom types for container IDs**: Considered type-level distinction between different container purposes, but central registry with simple string types was sufficient and more approachable.

- **Aggressive dead code removal without archive**: User wisely requested archive-then-delete with separate commits for safe rollback.

### Decisions Made

- **Central registry over phantom types**: Simpler pattern that maps cleanly to Halogen components. Easy to explain and verify.

- **Kahn's algorithm for topo sort**: Handles cycles gracefully by assigning cyclic nodes to final layer instead of infinite looping.

- **Two-commit archive strategy**: Provides rollback checkpoint before permanent deletion.

### Commits

1. `77e36cf` - CE2: Archive dead code (39 files) - Phase 7 cleanup checkpoint
2. `8bd5d6a` - CE2: Delete archived dead code (43 files)

### Next Session Setup

Phase 7 complete. The CE2 plan phases are now all done:
- ✅ Phase 1-6: Scene simplification, transitions, navigation
- ✅ Phase 7: Dead code cleanup

**Potential follow-up work:**
- Add more scenes to the navigation path (chord/matrix overlays)
- Improve transition animations (currently instant jumps for back navigation)
- Search box for "my app" / Main module navigation

**Rollback if needed:**
```bash
git checkout 77e36cf -- ce2-website/_archive/  # Restore specific files
```
