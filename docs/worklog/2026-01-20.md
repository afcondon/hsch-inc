# Worklog: 2026-01-20

## Session 1: Scale Transition Bug Fixes

### Accomplished

1. **Fixed treemap showing all 568 packages** instead of filtered set
   - `computeRelevantPackageIds` was missing a case for `ProjectDepsTreemapScale`
   - Fell through to default which returned ALL packages
   - Added delegation to `ProjectDepsScale` (same package set, different display)

2. **Fixed modules missing in treemap**
   - After MoveToTreemap→Crossfade transition, only backdrop rectangles were visible
   - Changed `finishScaleTransition` for `ProjectDepsTreemapScale` to call `SwitchToTreemap`
   - This renders the full treemap with modules instead of just the backdrop

3. **Fixed asymmetric zoom out** (Treemap → Swarm)
   - Added `removeTreemapBackdrop` FFI function
   - Called when jumping from `ProjectDepsTreemapScale` back to `ProjectDepsScale`
   - Beeswarm now renders cleanly without treemap backdrop behind it

### Files Modified

**ce2-website/src/Component/App.purs:**
- Added `ProjectDepsTreemapScale` case to `computeRelevantPackageIds`
- Updated `finishScaleTransition` for `ProjectDepsTreemapScale` to call `SwitchToTreemap`
- Added `removeTreemapBackdrop` call when zooming out to `ProjectDepsScale`

**ce2-website/src/Viz/ScaleTransition.purs:**
- Exported `removeTreemapBackdrop`
- Added FFI import

**ce2-website/src/Viz/ScaleTransition.js:**
- Added `removeTreemapBackdrop` function

### Database Exploration

Analyzed the data model to understand package groupings:
- **Registry packages**: 568 (in `package_set_packages`)
- **Project packages**: 139 total (122 overlap with registry + 17 local-only)
- **Local-only packages**: 17 (ce-*, psd3-*, tidal-*, etc.) with 645 modules

The client currently has two data sources:
- `modelData` - Project analysis (139 packages + modules)
- `packageSetData` - Full registry (568 packages)

### Parking Lot: Database Unification (Thursday)

**Postponed to Thursday** when token allocation resets.

The plan is to move data unification from client to database layer:
- Create clean API endpoints for package groupings (full-set, transitive, direct, project)
- Simplify client code to use unified API
- Put relationship computation in SQL queries at load time

Key insight: The treemap should show ~17 local packages with their 645 modules, not 122+ registry packages. Need to distinguish:
- `full-set`: All registry packages (for PackageSetScale beeswarm)
- `transitive`: Registry packages our project depends on (for ProjectDepsScale)
- `project-extra`: Local packages with source code (for treemap/ProjectOnlyScale)

### Testing Needed

- [ ] Forward: Package Set → Project+Deps (Swarm) → Project+Deps (Treemap)
- [ ] Verify treemap shows module circles inside packages
- [ ] Backward: Project+Deps (Treemap) → Project+Deps (Swarm) jumps instantly
- [ ] Verify beeswarm renders without treemap backdrop visible

### Next Session Setup

1. Test the transition fixes
2. Thursday: Execute refactoring plan at `docs/kb/plans/ce2-refactor-plan.md`

---

## Session 2: Refactoring Plan Created

### Accomplished

Created comprehensive plan for Thursday session: `docs/kb/plans/ce2-refactor-plan.md`

### Key Insights

**The FFI files are technical debt.** ~2000+ lines of imperative D3.js in ce2-website violates the core design philosophy:

> "PSD3 takes control from D3" - We don't write imperative D3 code that mutates the DOM directly

Current FFI files to refactor:
- `ScaleTransition.js` (722 lines)
- `PackageSetBeeswarm.js`, `BubblePackBeeswarm.js`
- `PackageSetTimeline.js`, `PackageSetView.js`
- `Triptych/*.js`

**However**, the prototype validated the UX:
- FadeOut → PopIn → MoveToTreemap → Crossfade works
- Zoom out instant jump works
- The transitions feel right

### Thursday Plan Summary

**Part 1: Data Unification**
- Single `/api/unified-packages` endpoint
- Pre-computed groupings (fullSet, transitive, local)
- Simplify client to set membership checks

**Part 2: FFI Refactoring**
- Replace imperative D3 with declarative `psd3-selection`
- GUP exit via data join, not manual `.remove()`
- Start with FadeOut phase (smallest scope)
- Document patterns for remaining files

### Success Criteria

1. No new FFI added - all fixes use library functions
2. ScaleTransition.js shrinks significantly
3. Client data model simplified
4. Transitions still work (UX preserved)
5. Code becomes exemplary library usage
