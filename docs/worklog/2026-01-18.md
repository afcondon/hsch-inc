# Worklog: 2026-01-18

## Session 1: README-to-Halogen Converter & psd3-tree Cleanup

### Session Focus
Create automated pipeline to generate library landing pages from README.md files, and clean up dead psd3-tree dependency.

### Accomplished

- **Created README-to-Halogen converter** (`tools/readme-to-halogen.mjs`):
  - Parses library README.md files and generates Halogen `Main.purs` for lib-sites
  - Extracts hero image links from markdown pattern `[![Alt](img)](url)`
  - Extracts tagline, overview, sections, and code examples
  - Demo URLs parsed from README, enabling single source of truth for both GitHub and website
  - Added `make lib-site-generate` target

- **Updated library READMEs with hero images**:
  - psd3-layout → `[![Layout Gallery Demo](../../site/lib-layout/public/demo.jpeg)](https://polyglot-purescript.org/layouts/)`
  - psd3-simulation → force-playground link
  - psd3-graph → honeycomb link
  - psd3-music → anscombe link
  - (psd3-selection left without hero - tree-builder showcase doesn't exist yet)

- **Deployed lib-sites to MacMini** - all 5 libraries returning 200

- **Removed dead psd3-tree package**:
  - psd3-tree was a thin wrapper around tree-rose providing `treeMapDeep`, `leaf`, `node` helpers
  - None of the 9 dependent libraries actually imported these functions
  - Removed psd3-tree from extraPackages in all spago.yaml files
  - Replaced with direct tree-rose dependency where needed
  - Deleted `visualisation libraries/purescript-psd3-tree/`
  - All builds verified working

- **Updated psd3-layout README**:
  - Treemap now lists all tiling algorithms (squarify, slice, dice, sliceDice, binary)
  - Updated "Part of PSD3" section to reference tree-rose instead of psd3-tree

### Files Created
- `tools/readme-to-halogen.mjs` - README to Halogen converter

### Files Modified
- `Makefile` - Added `lib-site-generate` target
- `visualisation libraries/purescript-psd3-layout/README.md` - Hero image, treemap algorithms, tree-rose reference
- `visualisation libraries/purescript-psd3-simulation/README.md` - Hero image
- `visualisation libraries/purescript-psd3-graph/README.md` - Hero image
- `visualisation libraries/purescript-psd3-music/README.md` - Hero image
- 9 spago.yaml files - Removed psd3-tree dependency

### Files Deleted
- `visualisation libraries/purescript-psd3-tree/` (entire directory)

### Decisions Made

- **README is single source of truth**: Library landing pages are now generated from README.md. Edit the README, run `make lib-site-generate && make lib-sites`, deploy.

- **Hero image pattern**: `[![Alt](relative-path-to-image)](absolute-url-to-demo)` displays on GitHub and gets parsed for the Halogen site.

- **Direct tree-rose dependency**: All libraries now depend directly on tree-rose from the registry rather than through the psd3-tree wrapper.

### Parking Lot

- Make demo apps consistent in name, location, and routing. Specifically: `tree-builder` and `force-playground` should be separate app bundles in the `showcases/` directory structure (like `honeycomb`, `anscombe`, `layouts`), not routes within the main SPA.
- Bidirectional DAG ↔ Graph converter: `toGraph :: DAGTree -> Graph` and `fromGraph :: Graph -> Maybe DAGTree`
- DAGTree is at `/#/tour/graph-algorithms` but could be more prominently featured

### Next Session Setup

**Workflow for library pages:**
```bash
# Edit README
vim 'visualisation libraries/purescript-psd3-layout/README.md'

# Regenerate and build
make lib-site-generate && make lib-sites

# Deploy
/deploy lib-sites
```

**Before editing READMEs**: Review them with reference to `docs/kb/reference/claude-context.md` and the knowledge base to ensure consistency and accuracy.

**Key files:**
- `tools/readme-to-halogen.mjs` - The converter (LIBRARY_CONFIG has demo URLs)
- `visualisation libraries/purescript-psd3-*/README.md` - Source of truth
- `site/lib-*/src/Main.purs` - Generated output

---

## Session 2: D3 Dependency Reduction Phases 2 & 5 + Unified Transition Model Design

### Session Focus
Continue D3 dependency reduction plan (Phases 2, 5), assess Phase 6 risk, and design unified transition model.

### Accomplished

- **Committed Phase 2**: d3-hierarchy removal and Code Explorer dead code cleanup (656 lines JS + 26 lines PS removed)

- **Completed Phase 5 - Transition System Unification**:
  - Created `PSD3.Transition.Interpolate` module:
    - Point interpolation (`lerpPoint`, `lerpPointXY`)
    - RGB color interpolation with CSS parsing (`lerpRGB`, `cssToRGB`, `rgbToCSS`)
    - HSL color interpolation with shortest-path hue (`lerpHSL`, `hslToCSS`)
    - Color conversions (`hslToRGB`, `rgbToHSL`)
    - `Interpolatable` typeclass for generic interpolation
  - Created `PSD3.Transition.Engine` module:
    - `TransitionSpec` - defines from/to values, duration, easing, interpolation
    - `TransitionState` - current state of in-flight transition
    - `TransitionGroup` - coordinate multiple transitions
    - Functions: `start`, `tick`, `currentValue`, `isComplete`, `remaining`
    - Framework-agnostic (works with Halogen and React)
    - Pure, deterministic state updates (no side effects)

- **Assessed Phase 6 (d3-transition replacement)**:
  - Initially thought d3-transition was dead code (grep found no imports)
  - User prompted investigation of TourMotionScrolly.purs
  - Discovered full usage chain: TourMotionAnimations → Capabilities.Transition → D3 interpreter → TransitionFFI
  - All d3-transition usage is in website demos/tour only (not showcases)
  - Identified fundamental incoherence: d3-transition and tick-based Engine don't compose well (same problem D3 has - transitions and simulations both want to control element attributes)

- **Flagged d3-brush for coordinated interaction design**: Added "Future: Coordinated Interaction Framework" section to plan, noting brush-and-link, coordinate hover, synchronized zoom/pan as related concerns

- **Created Unified Transition Model design document** (`docs/kb/architecture/unified-transition-model.md`):
  - Documents the incoherence problem between d3-transition, tick-based Engine, and simulation
  - Introduces Attribute Ownership concept (which mechanism controls which attributes)
  - Analyzes open questions with user input:
    - Staggering: makes sense for transitions, not simulation
    - Chaining: explicit in Engine, no concept in simulation
    - Interruption: undefined behavior, potential crashes
    - WASM coordination: must be working somehow (TODO: investigate)
  - Proposes unified types: `AttributeMode`, `PositionMode`, `TickSource`, `TransitionEngine`
  - Explores type-level enforcement with phantom types

### Files Created
- `visualisation libraries/purescript-psd3-simulation/src/PSD3/Transition/Interpolate.purs`
- `visualisation libraries/purescript-psd3-simulation/src/PSD3/Transition/Engine.purs`
- `docs/kb/architecture/unified-transition-model.md`

### Files Modified
- `docs/kb/plans/d3-dependency-reduction.md` - Updated phases 2, 5 as complete
- `docs/kb/INDEX.md` - Added unified-transition-model.md to Architecture section

### Explored But Not Pursued

- **Immediate Phase 6 execution**: Too high risk without understanding the unified model. The current d3-transition usage in tour demos is legitimate and should work correctly with any replacement.

- **Removing TransitionFFI**: The FFI is actively used through the Capabilities.Transition → D3 interpreter chain. Can't remove without breaking tour animations.

### Decisions Made

- **Attribute ownership is the key insight**: Different mechanisms should own different attributes. Position can't be BOTH transitioned and simulated simultaneously, but they CAN coexist temporally (enter: transition opacity while simulation takes over position).

- **Type-level enforcement is desirable**: Phantom types could make invalid states unrepresentable (e.g., can't call `withTransition` on a simulated element).

- **d3-brush is related to coordinated interaction**: Not just about replacing one D3 module, but designing a principled framework for brush-and-link, coordinate hover, and synchronized interactions across components.

### Parking Lot

- Document actual WASM tick flow in wasm-force-demo
- Prototype `PositionMode` in AST, see what breaks
- Type-level experiment with phantom types for attribute ownership enforcement
- Inventory exactly which attributes are transitioned where across all demos
- Design session for unified tick coordinator

### Next Session Setup

**Key document to review**: `docs/kb/architecture/unified-transition-model.md`

**Continue with**:
1. Brainstorm unified model (per user request)
2. Investigate WASM tick flow in `showcases/wasm-force-demo/`
3. Consider type-level enforcement prototypes

**Key files for reference**:
- `PSD3.Transition.Engine` - New tick-driven transition engine
- `PSD3.Transition.Interpolate` - Type-safe interpolation
- `PSD3.Internal.Transition.FFI` - Current d3-transition bindings
- `site/website/src/Component/Tour/TourMotionAnimations.purs` - Where d3-transition is actually used
