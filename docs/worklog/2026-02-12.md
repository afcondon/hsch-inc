# Worklog: 2026-02-12

## Session Focus
Reconstitute full Polyglot deployment from reorganized workspace; fix broken services; establish dedicated deploy repo; introduce zipapp bundling for PurePy backends.

## Accomplished

### Deployment Infrastructure
- **Created `polyglot-deploy/` repo** — dedicated home for `docker-compose.yml` and `deploy-remote.sh`, solving the problem that the workspace root (`afc-work/`) isn't a git repo. All Docker build context paths use `../` to reference sibling repos.
- **Fixed docker-compose.yml paths** for reorganized directories — tidal-backend now points to `purescript-ports/purerl-tidal`, all other paths verified against filesystem
- **Rewrote `deploy-remote.sh`** — targeted rsync of only directories needed by docker-compose, profile parameter support, auto-builds PurePy zipapp bundles before sync
- **Deployed full profile** (24 services) to MacMini via TailScale — all 19 routes returning 200

### Edge Router Fixes
- **Added trailing-slash redirects** in OpenResty Lua router — bare `/psd3/<lib>` was causing `<script src="bundle.js">` to resolve against the wrong path. Added 301 redirect for `/psd3/<lib>` -> `/psd3/<lib>/` in both `dist/edge.lua` and `lua-ffi/src/Main.lua`

### Library Demo Fixes
- **Replaced broken symlink** for lib-selection demo (pointed to pre-reorg path with space in name)
- **Copied demo files** from `purescript-hylograph-libs` for lib-layout, lib-graph, lib-music, lib-simulation — these directories were missing entirely, causing nginx SPA fallback to serve index.html as bundle.js (MIME type mismatch)

### PurePy Backend Fix + Zipapp Bundling
- **Diagnosed ge-backend crash** — `ModuleNotFoundError: No module named 'control_extend_foreign'`. Traced to commit `899eadd` which deleted ~150 Python FFI foreign files as "obsolete" — they weren't
- **Restored 9 missing foreign files** from git history (`git show 899eadd~1:...`) for ge-server, copied 5 shared ones to ee-server
- **Introduced zipapp bundling** — `python3 -m zipapp output-py -o app.pyz` produces a single 800K deployable artifact from 200+ loose .py files
- **Updated Dockerfiles** — `COPY app.pyz .` + `CMD ["python", "app.pyz"]` replaces copying entire output-py/ directory
- **Added Makefile** in hypo-punter/ — `make bundle` builds both app.pyz files
- **Tracked app.pyz in git** (like bundle.js for JS backends), fully gitignored output-py/ — clean separation of deployable artifact from intermediate build output

### Git Housekeeping
- **Initialized git repos** for 7 showcase directories that lacked them
- **Created 14 private GitHub repos** and pushed: polyglot-deploy + 13 showcase repos
- **Pushed unpushed commits** across purescript-polyglot (8), hypo-punter (3), HeresiarchHalogen (6)

## Decisions Made

- **Dedicated deploy repo over monorepo** — `polyglot-deploy/` with relative `../` paths keeps deployment config versioned without polluting the workspace root or any single project repo
- **app.pyz as deployable artifact** — analogous to bundle.js in JS PureScript projects. Track the bundle, gitignore the intermediates. Compiler output (output-py/) is fully transient, regenerated by `spago build && purepy && make bundle`
- **Private repos by default** — all new GitHub repos created as private; can be selectively opened later
- **Profile-aware deploy** — deploy script takes a profile parameter (`minard`, `hypo`, `full`, etc.) matching docker-compose profiles, avoiding the "no service selected" problem

## Explored But Not Pursued

- Tracking `*_foreign.py` files individually in git (with gitignore negation) — initially implemented but superseded by the zipapp approach which is cleaner
- Building PurePy inside Docker — would require the Haskell-built `purepy` binary in the container; compiling locally and deploying the .pyz is simpler

## Parking Lot

- `mattermost-tailscale` repo has no remote — infrastructure config, not Hylograph-related
- ee-server may crash at runtime for endpoints using Data.Maybe (the foreign file fix prevents startup crash but some code paths may hit other missing FFI at runtime)
- Tidal backend health — deployed but not specifically tested this session
- The `purepy` compiler could potentially be enhanced to produce zipapp directly as a build output

## Verified

- All services accessible via TailScale Funnel at `https://andrews-mac-mini.vaquita-paradise.ts.net`
- Both PurePy demos (Embedding Explorer, Grid Explorer) confirmed working on MacMini
- All repos pushed — no unpushed commits remain (except `mattermost-tailscale` which has no remote)

## Next Session Setup

- Minard search typeahead is planned and designed (plan file exists) but not yet implemented
- Deploy: `cd polyglot-deploy && ./deploy-remote.sh andrew@100.101.177.83 full /Users/andrew/psd3`
- PurePy rebuild: `cd hypo-punter && spago build && purepy && make bundle`
- Funnel URL: `https://andrews-mac-mini.vaquita-paradise.ts.net`
