# Worklog: 2026-01-12

## Session Focus
Meta-session to improve Claude Code collaboration practices: establishing session logging, knowledge base structure, and engineering discipline guardrails.

## Accomplished
- Created `docs/worklog/` structure for session logging
- Added session logging practices to CLAUDE.md
- Established template for daily worklog entries
- Deep analysis of all spago.yaml files across showcases/, site/, visualisation libraries/
- Cross-referenced Makefile bundle targets with spago.yaml configs and index.html imports
- Documented build conventions for all 6 backends in CLAUDE.md
- Established "Rule Zero": ALL builds through Makefile only
- Added `make verify-bundles` target to check co-location rule
- Enforced strict bundle naming: `bundle.js` only (no exceptions)
- Standardized 4 non-conforming projects (psd3-tidal, demo-website, react-proof, showcase-shell-demo)
- Fixed showcase-shell-demo spago.yaml extraPackages paths
- Deleted stale bundle files (app.js, index.js, output/bundle.js)
- Created knowledge base structure (`docs/kb/`) with 6 categories
- Classified 38 markdown reports across the ecosystem
- Created INDEX.md with full report catalog and metadata
- Copied key docs to kb/ (kernel-separation, polyglot-ffi, hackage-analysis, claude-context)
- Added KB conventions to CLAUDE.md

## Key Findings from Build Analysis

**Discrepancies identified:**
- `wasm-force-demo`: spago.yaml has no bundle config; Makefile bundles to `dist/bundle.js` but index.html uses WASM directly (special case)
- `psd3-arid-keystone`: spago.yaml has no bundle config; Makefile is sole source of truth for `demo/bundle.js`
- Two bundle naming conventions: `bundle.js` (standard) vs `index.js` (psd3-tidal, site/website)

**What works well:**
- Co-location rule holds: all index.html files reference bundles in same directory
- Makefile correctly handles all the complexity
- When both spago.yaml and Makefile specify paths, they agree

**Root cause of past issues:**
- Running `spago bundle` directly without Makefile leads to wrong outputs
- Projects without spago.yaml bundle config REQUIRE the Makefile flags

**Verification results (`make verify-bundles`):**
- 10/10 browser targets now pass verification
- Standardized all to `bundle.js` (no exceptions)

## Explored But Not Pursued
- Automatic spago.yaml generation from Makefile (too complex, Makefile is already source of truth)
- Unified registry version across all projects (different projects have different requirements: 57.1.0, 67.0.1, 70.0.0)

## Parking Lot
- Integrating KB with existing Antora docs infrastructure
- Adding frontmatter to all 38 indexed reports (currently only key docs have it)
- Periodic KB maintenance: re-classify stale reports, update index

## Decisions Made
- Worklog lives in `docs/worklog/` with dated files (YYYY-MM-DD.md)
- Template provides consistent structure without being burdensome
- "Explored But Not Pursued" section specifically captures abandoned paths
- **Makefile is the canonical source of truth** for build commands
- **Co-location rule** is the key invariant for browser targets
- Build conventions documented per-backend in CLAUDE.md

## Reports Generated
- Build conventions added to CLAUDE.md (not a separate report)

## Next Session Setup
- Run `make verify-bundles` after builds to catch issues early
- Consult `docs/kb/INDEX.md` when entering unfamiliar territory
- All browser targets standardized on `bundle.js` in same directory as `index.html`

## Session Outcome
Successful meta-session establishing infrastructure for sustainable high-velocity development. Key insight shared with colleagues: Claude's "hallucinations" in complex projects are often "most probable commands" - codifying conventions in CLAUDE.md turns guesses into rules.

---

## Session 2: Kernel Separation Planning

### Focus
Phase 2 planning for kernel separation architecture - extracting psd3-simulation into three packages.

### Accomplished
- Deep analysis of psd3-simulation module structure:
  - Identified 21 PureScript modules
  - Mapped 8 FFI files (Core.js, Simulation.js, WASM.js, WASMEngine.js, etc.)
  - Traced dependency chains through imports
- Identified kernel-agnostic vs kernel-specific code:
  - **Core (agnostic)**: Scene.Types, Scene.Engine, Transition.Tick
  - **D3-specific**: ForceEngine.*, Scene.Handle, Simulation.Scene, Config.*
  - **WASM-specific**: ForceEngine.WASM, ForceEngine.WASMEngine
- Key finding: `Handle.purs` is D3-coupled (imports Simulation, Core FFI)
- Created detailed Phase 2 plan: `docs/kb/plans/kernel-separation-phase2.md`
  - Target structure: psd3-simulation-core, psd3-d3-kernel, psd3-wasm-kernel
  - Module migration mapping
  - API changes (explicit kernel choice)
  - Verification checklist
- Updated KB INDEX.md (39 documents total)
- Updated kernel-separation.md architecture doc with Phase 2 reference

### Key Design Decision
`EngineAdapter` is the abstraction boundary. Portable code written against `EngineAdapter` works with any kernel:

```purescript
runVisualization :: forall node. EngineAdapter node -> SceneConfig node -> Effect Unit
```

### Implementation Progress

**Completed:**
1. Created `psd3-simulation-core` package:
   - `PSD3.Simulation.Core.Types` - PositionMap, NodeRule, SceneConfig, EngineMode
   - `PSD3.Simulation.Core.Tick` - lerp, easing functions, tick tracking
   - `PSD3.Simulation.Core.Engine` - EngineAdapter interface, createEngine, tick, transitionTo
   - Package builds successfully with no FFI dependencies

2. Created `psd3-d3-kernel` package:
   - `PSD3.Kernel.D3.Types` - Force configuration types (ManyBodyConfig, etc.)
   - `PSD3.Kernel.D3.Core` + FFI - D3 force functions, animation loop, drag
   - `PSD3.Kernel.D3.Adapter` - mkAdapter creates EngineAdapter from D3 components
   - Package builds successfully, depends on core

3. Created `psd3-wasm-kernel` package:
   - `PSD3.Kernel.WASM.FFI` + FFI - WASM simulation bindings
   - `PSD3.Kernel.WASM.Engine` + FFI - mkAdapter creates EngineAdapter from WASM sim
   - Package builds successfully, depends on core

**Remaining:**
- Copy remaining D3 modules (Simulation, Links, Render, Events, etc.)
- Update D3-based examples to use new packages

**Decision:** Skip backward compatibility - migrate examples forward instead.

---

## Session 3: Kernel Migration

### Focus
Migrating showcase apps to use new kernel packages.

### Accomplished
- Updated `wasm-force-demo` to use `psd3-wasm-kernel`:
  - Changed spago.yaml: `psd3-simulation` → `psd3-wasm-kernel` + `psd3-simulation-core`
  - Updated imports: `PSD3.ForceEngine.WASM` → `PSD3.Kernel.WASM.FFI`
  - Removed unused WASMEngine import (demo uses FFI directly)
  - Cleaned up unused imports (Data.Maybe, Data.Traversable, etc.)
  - Build succeeds with no warnings

### D3 Kernel Modules Copied
Essential modules now in psd3-d3-kernel:
- `Core.purs + FFI` - Force creation, animation loop, drag behavior
- `Types.purs` - Force configurations, SimNode, ForceSpec
- `Adapter.purs` - Creates EngineAdapter from D3 components
- `Events.purs` - Callback system (SimulationCallbacks, SimulationEvent)
- `Simulation.purs + FFI` - High-level simulation API
- `Links.purs + FFI` - Link swizzling and filtering

All modules build successfully.

### Projects Remaining for Migration
D3-based projects (D3 kernel now ready):
- `showcases/hypo-punter/ge-website/`
- `showcases/corrode-expel/` and `ce2-website/`
- `showcases/psd3-tilted-radio/purescript-psd3-tidal/`
- `site/website/`
- `site/react-proof/`
- `visualisation libraries/psd3-astar-demo/`
- `visualisation libraries/purescript-psd3-simulation-halogen/`

### Next Steps
1. Update `psd3-simulation-halogen` to use D3 kernel
2. Migrate D3-based examples to new package structure

---

## Session 4: WASM Canvas Enhancement

### Focus
Completing the WASM Canvas Enhancement plan - Canvas library extraction, zoom/pan, force controls.

### Accomplished

**Phase 1: Canvas Library Extraction**
- Created `purescript-psd3-canvas` package:
  - `PSD3.Canvas` - Core canvas API (createCanvas, beginScene, setTransform, drawCircles, drawLines)
  - `PSD3.Canvas.Zoom` - Zoom/pan event handling and transform helpers
  - Types: CanvasConfig, Transform, CircleSpec, LineSpec, ZoomEvent, DragEvent
- Updated ForcePlaygroundWASM to use new library (removed inline CanvasRenderer)
- FFI cleanup: replaced custom isNaN with Data.Number.isNaN

**Phase 2: Zoom/Pan Support**
- Added subscribeWheel and subscribeDrag for event handling
- Implemented zoomAt and pan transform helpers
- Used Ref-based transform storage for high-frequency mouse events

**Phase 3: Rust WASM Kernel Forces**
- Added forceX, forceY, forceCollide to Rust kernel (lib.rs)
- Implemented Barnes-Hut quadtree for collision detection
- Added configure_force_x, configure_force_y, configure_collide methods
- Added enable_forces_all for dynamic force configuration
- Updated PureScript FFI bindings (ForceXConfig, ForceYConfig, CollideConfig)
- Rebuilt WASM and deployed to website

**Phase 4: Force Toggle UI (D3 Parity)**
- Added WASMForceId type with 6 force types:
  - ForceManyBody (charge/repulsion)
  - ForceLinks (spring links)
  - ForceCenter (center gravity)
  - ForceXCenter (pull to X)
  - ForceYCenter (pull to Y)
  - ForceCollide (collision detection)
- Added enabledForces state to ForcePlaygroundWASM
- Created force toggle UI with 6 buttons
- Wired up ToggleForce action to call Sim.enableForcesAll
- Added CSS styling for floating panels and force toggles

**Cleanup**
- Removed unused Tangle modules (Core, DragEvents, Halogen, TidalTangle)
- Removed PatternTree visualization modules
- Removed AlgoraveViz component
- Removed inline CanvasRenderer (replaced by psd3-canvas)

### Key Technical Decisions
- **Ref-based transform**: High-frequency mouse events update a Ref directly, avoiding Halogen state overhead
- **NaN for unfixed nodes**: WASM kernel uses NaN convention for fx/fy (matching D3)
- **Default forces**: ManyBody + Links + Center enabled by default (matching D3 behavior)

### Build Verification
- Makefile uses `PATH="$(RUST_PATH)"` for wasm-pack (ensures rustup's Rust, not Homebrew)
- Added `serve-website` target to Makefile for demo site serving
- All builds pass, bundle ready for browser testing

### Files Changed
- `site/website/src/Component/ForcePlaygroundWASM.purs` - Force controls
- `site/website/public/psd3.css` - UI styling
- `showcases/wasm-force-demo/force-kernel/src/lib.rs` - Rust forces
- `visualisation libraries/purescript-psd3-canvas/` - New package
- `visualisation libraries/purescript-psd3-wasm-kernel/` - FFI updates
