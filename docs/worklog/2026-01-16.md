# Worklog: 2026-01-16

## Session 1: Optic Menagerie & Finally Tagless AST

### Accomplished

1. **Created new showcase: psd3-optic-menagerie**
   - Swiss/Tufte aesthetic (Helvetica, off-white, minimal chrome)
   - Two-tree side-by-side layout showing optic transformations
   - Heterogeneous `Shape` ADT (Circle, Square, Triangle, Diamond, Table)
   - Five demo optics that transform colors by shape/depth
   - Pure Halogen/SVG rendering - deliberately NOT using PSD3 AST yet

2. **Identified AST limitation**
   - Current AST can't elegantly express "render circle OR square OR triangle depending on datum"
   - `ConditionalRender` exists but operates at wrong abstraction level (whole trees, not element types)

3. **Designed solution: Finally Tagless AST**
   - Key insight: `SelectionM` is already finally tagless, apply same pattern to AST
   - `TreeDSL` typeclass for core operations
   - Extensions via additional typeclasses (`ShapeTreeDSL`, etc.)
   - Extensibility without modifying core library
   - Full design documented in `docs/kb/plans/finally-tagless-ast.md`

### Explored But Not Pursued

- **Approach 1: Use existing ConditionalRender** - Too verbose, each branch builds whole Tree
- **Approach 2: Data-dependent ElementType** - Breaks all existing code
- **Approach 3: ShapeSwitch constructor** - More AST complexity, not general enough
- **Approach 4: Datum IS the shape** - Clever but doesn't feel natural
- **Code generation for ADT extensions** - Deferred; finally tagless may obviate need

### Decisions Made

1. **Feature branch** - Working on `feature/heterogeneous-ast` to protect main
2. **Finally tagless over ADT extension** - More principled, matches existing SelectionM pattern
3. **Prove with prototype first** - Optic Menagerie demonstrates the need before we refactor core
4. **Tufte/Swiss styling** - Austere aesthetic for complex subject matter

### Parking Lot

- How does layout work with extensible node types? Each node type needs dimension queries
- Should `ShapeSpec` live in core library or be user-defined?
- Performance implications of tagless encoding
- 3D, animation, sonification as future TreeDSL extensions

### Next Session Setup

1. Attempt the TreeDSL refactor:
   - Define `TreeDSL` typeclass mirroring current AST constructors
   - Create initial/free encoding `TreeAST`
   - Migrate one simple demo to use `TreeDSL` constraint
   - Verify it still works

2. Then add `ShapeTreeDSL`:
   - Define the extension typeclass
   - Implement for D3 interpreter
   - Rewire Optic Menagerie to use it

Branch: `feature/heterogeneous-ast`
Showcase: `showcases/psd3-optic-menagerie` (running on port 8095)
Design doc: `docs/kb/plans/finally-tagless-ast.md`

---

## Session 2: TreeDSL Implementation & Emptier Coinage

### Accomplished

1. **Implemented TreeDSL typeclass** (psd3-selection)
   - `PSD3.TreeDSL` - finally-tagless typeclass mirroring AST operations
   - Added `TreeDSL Tree` instance to `PSD3.AST`
   - All existing libraries and demos still build

2. **Implemented ShapeTreeDSL extension** (psd3-selection)
   - `PSD3.TreeDSL.ShapeTree` - extension for heterogeneous shape rendering
   - `ShapeSpec` ADT: CircleSpec, RectSpec, PolygonSpec, TableSpec, GroupSpec
   - Principled implementation - no unsafeCoerce needed
   - Uses `conditionalRender` under the hood

3. **Renamed showcase to Emptier Coinage** (anagram of "Optic Menagerie")
   - Wired up D3 rendering via `renderTreeD3`
   - Domain `Shape` ADT converted to `ShapeSpec` for PSD3
   - Added bezier link paths using `linkBezierVertical` from psd3-layout (pure PS)
   - Shapes render correctly: circles, squares, triangles, diamonds

4. **Validated D3 dependency approach**
   - Confirmed FFI uses d3-selection, d3-force, d3-hierarchy, etc.
   - Noted need for audit: should only need d3-selection for DOM
   - Algorithms (layout, force) should be pure PureScript

### Explored But Not Pursued

- Minimal D3 bundle - deferred, works with full bundle for now

### Parking Lot

- **D3 dependency audit**: Ensure we only use d3-selection for DOM manipulation, not d3-hierarchy/d3-force for algorithms
- **Shaped Steer integration**: Lenses and prisms in the build tree DAG would be fascinating
  - The build graph is already a tree/DAG structure
  - Could visualize optic paths through the dependency graph
  - "Focus" on a cell and see what it affects via lenses
  - Prisms for pattern matching on cell types

### Files Changed

**psd3-selection:**
- `src/PSD3/TreeDSL.purs` (new)
- `src/PSD3/TreeDSL/ShapeTree.purs` (new)
- `src/PSD3/AST.purs` (added TreeDSL instance)

**emptier-coinage:**
- `src/Optics/Types.purs` - Shape ADT with Ord instance
- `src/Optics/PSD3View.purs` - ShapeTreeDSL integration + bezier links
- `src/Optics/Component.purs` - D3 rendering hooks

### Next Steps

1. Add more link styling options
2. Consider tree layout algorithms (pure PS)
3. Audit D3 dependencies across codebase
4. Explore Shaped Steer integration for optics visualization
