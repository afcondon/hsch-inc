# Worklog: 2026-01-16

## Session 1: Optic Menagerie & Finally Tagless AST

### Accomplished

1. **Created new showcase: psd3-optic-menagerie**
   - Swiss/Tufte aesthetic (Helvetica, off-white, minimal chrome)
   - Two-tree side-by-side layout showing optic transformations
   - Heterogeneous `Shape` ADT (Circle, Square, Triangle, Diamond, Table)
   - Five demo optics that transform colors by shape/depth
   - Pure Halogen/SVG rendering - deliberately NOT using PSD3 AST yet

2. **Identified AST limitation**
   - Current AST can't elegantly express "render circle OR square OR triangle depending on datum"
   - `ConditionalRender` exists but operates at wrong abstraction level (whole trees, not element types)

3. **Designed solution: Finally Tagless AST**
   - Key insight: `SelectionM` is already finally tagless, apply same pattern to AST
   - `TreeDSL` typeclass for core operations
   - Extensions via additional typeclasses (`ShapeTreeDSL`, etc.)
   - Extensibility without modifying core library
   - Full design documented in `docs/kb/plans/finally-tagless-ast.md`

### Explored But Not Pursued

- **Approach 1: Use existing ConditionalRender** - Too verbose, each branch builds whole Tree
- **Approach 2: Data-dependent ElementType** - Breaks all existing code
- **Approach 3: ShapeSwitch constructor** - More AST complexity, not general enough
- **Approach 4: Datum IS the shape** - Clever but doesn't feel natural
- **Code generation for ADT extensions** - Deferred; finally tagless may obviate need

### Decisions Made

1. **Feature branch** - Working on `feature/heterogeneous-ast` to protect main
2. **Finally tagless over ADT extension** - More principled, matches existing SelectionM pattern
3. **Prove with prototype first** - Optic Menagerie demonstrates the need before we refactor core
4. **Tufte/Swiss styling** - Austere aesthetic for complex subject matter

### Parking Lot

- How does layout work with extensible node types? Each node type needs dimension queries
- Should `ShapeSpec` live in core library or be user-defined?
- Performance implications of tagless encoding
- 3D, animation, sonification as future TreeDSL extensions

### Next Session Setup

1. Attempt the TreeDSL refactor:
   - Define `TreeDSL` typeclass mirroring current AST constructors
   - Create initial/free encoding `TreeAST`
   - Migrate one simple demo to use `TreeDSL` constraint
   - Verify it still works

2. Then add `ShapeTreeDSL`:
   - Define the extension typeclass
   - Implement for D3 interpreter
   - Rewire Optic Menagerie to use it

Branch: `feature/heterogeneous-ast`
Showcase: `showcases/psd3-optic-menagerie` (running on port 8095)
Design doc: `docs/kb/plans/finally-tagless-ast.md`

---

## Session 2: TreeDSL Implementation & Emptier Coinage

### Accomplished

1. **Implemented TreeDSL typeclass** (psd3-selection)
   - `PSD3.TreeDSL` - finally-tagless typeclass mirroring AST operations
   - Added `TreeDSL Tree` instance to `PSD3.AST`
   - All existing libraries and demos still build

2. **Implemented ShapeTreeDSL extension** (psd3-selection)
   - `PSD3.TreeDSL.ShapeTree` - extension for heterogeneous shape rendering
   - `ShapeSpec` ADT: CircleSpec, RectSpec, PolygonSpec, TableSpec, GroupSpec
   - Principled implementation - no unsafeCoerce needed
   - Uses `conditionalRender` under the hood

3. **Renamed showcase to Emptier Coinage** (anagram of "Optic Menagerie")
   - Wired up D3 rendering via `renderTreeD3`
   - Domain `Shape` ADT converted to `ShapeSpec` for PSD3
   - Added bezier link paths using `linkBezierVertical` from psd3-layout (pure PS)
   - Shapes render correctly: circles, squares, triangles, diamonds

4. **Validated D3 dependency approach**
   - Confirmed FFI uses d3-selection, d3-force, d3-hierarchy, etc.
   - Noted need for audit: should only need d3-selection for DOM
   - Algorithms (layout, force) should be pure PureScript

### Explored But Not Pursued

- Minimal D3 bundle - deferred, works with full bundle for now

### Parking Lot

- **D3 dependency audit**: Ensure we only use d3-selection for DOM manipulation, not d3-hierarchy/d3-force for algorithms
- **Shaped Steer integration**: Lenses and prisms in the build tree DAG would be fascinating
  - The build graph is already a tree/DAG structure
  - Could visualize optic paths through the dependency graph
  - "Focus" on a cell and see what it affects via lenses
  - Prisms for pattern matching on cell types

### Files Changed

**psd3-selection:**
- `src/PSD3/TreeDSL.purs` (new)
- `src/PSD3/TreeDSL/ShapeTree.purs` (new)
- `src/PSD3/AST.purs` (added TreeDSL instance)

**emptier-coinage:**
- `src/Optics/Types.purs` - Shape ADT with Ord instance
- `src/Optics/PSD3View.purs` - ShapeTreeDSL integration + bezier links
- `src/Optics/Component.purs` - D3 rendering hooks

### Next Steps

1. Add more link styling options
2. Consider tree layout algorithms (pure PS)
3. Audit D3 dependencies across codebase
4. Explore Shaped Steer integration for optics visualization

---

## Session 3: Tables as Nodes & Size-Aware Tree Layout

### Accomplished

1. **Full table rendering in ShapeTreeDSL** (psd3-selection)
   - `renderTable` now creates SVG grid with rect cells and text elements
   - Each cell positioned via group transforms
   - Header row visually distinct from data rows
   - Text content via `textContent` pseudo-attribute
   - Tables centered on their position via transform offset

2. **Tables as tree nodes with optics** (emptier-coinage)
   - `treeWithTableBranches`: tables as internal nodes with shape children
   - Full `TableSpec` conversion with dynamic dimensions
   - `AddUsersToBlueTables` optic: traverses into table rows, bumps Users values
   - Demonstrates optics reaching into structured data within heterogeneous nodes

3. **Size-aware Reingold-Tilford layout** (psd3-layout)
   - New `treeSized` function for heterogeneous node sizes
   - **Edge-based contours**: tracks `center ± width/2` instead of just centers
   - **Variable layer heights**: computes max height per depth, accumulates y
   - `minSeparation` now means pure gap between node edges
   - Centered x output: maps to `[-width/2, +width/2]` for easy SVG centering
   - Proper nesting of wide nodes (tables) with their children

4. **Stress test tree** (emptier-coinage)
   - `stressTestTree`: ~35 nodes, 4 levels deep
   - Large tables at interior nodes (analytics 4×4, data 5×3)
   - Small table as leaf (MaxFlow 2×2)
   - Mixed shapes throughout
   - Validates layout handles heterogeneous sizes correctly

5. **Centered shape rendering** (psd3-selection)
   - `rectAttrs` now includes `x: -width/2, y: -height/2` to center rects
   - `renderTable` wraps content in group with centering transform
   - Circles already centered (SVG uses cx, cy)
   - Polygons already centered (points relative to origin)

### Key Insight

The Reingold-Tilford algorithm's contours naturally support variable-width nodes when you track edges instead of centers. The contour at each depth represents the physical extent of the subtree, so when comparing adjacent subtrees for overlap, you're comparing actual edges. This makes `minSeparation` a true gap value rather than center-to-center distance.

### Files Changed

**psd3-layout:**
- `src/DataViz/Layout/Hierarchy/Tree.purs` - added `treeSized`, `NodeSize`, edge-based contour functions

**psd3-selection:**
- `src/PSD3/TreeDSL/ShapeTree.purs` - full table rendering, centered rects

**emptier-coinage:**
- `src/Optics/Types.purs` - `stressTestTree`, table examples
- `src/Optics/PSD3View.purs` - `treeSized` integration, sizing function
- `src/Optics/Component.purs` - larger viewBox, `AddUsersToBlueTables` optic

### Parking Lot

- **D3 dependency audit** (carried forward)
- **Shaped Steer integration** (carried forward)
- Consider making layout size/viewBox dynamic based on actual tree extent
- Text rendering in tables could use `foreignObject` for better formatting
- Animation between optic states would be compelling

### WIP Commits

- psd3-layout `9249933`: treeSized with edge-based contours
- psd3-selection `7271110`: centered rect/table rendering
- emptier-coinage `de867ff`: size-aware layout + stress test

---

## Session 4: Full Optics Showcase & Polish

### Accomplished

1. **Expanded optics into organized categories** (emptier-coinage)
   - **Focus** (Lens): root, first table
   - **Select** (Traversal): circles, squares, tables, leaves, depth 2
   - **Transform**: identity, circles→red, squares→green, all→black, circles×1.5, tables+row, blue tables+users
   - **Aggregate** (Fold): count circles, count by shape, sum radii, max depth

2. **Selection visualization fix**
   - Original approach: highlight selected nodes in gold (confusing - looked like transformation)
   - New approach: dim unselected nodes to gray
   - `dimUnselected` functions that traverse tree and gray out non-matching shapes
   - Clearer pedagogically: "these are what the optic sees" vs "these were changed"

3. **Fixed doubled trees bug**
   - D3 was appending to existing content on re-render
   - Added `clear selector` call in `renderTreeD3` before building new tree
   - Imported `clear` from `PSD3.Internal.Capabilities.Selection`

4. **Simplified layout to full-width two-column**
   - Removed arrow and curly brace (tried but too complex)
   - Full viewport width with CSS breakout: `width: 100vw; margin-left: calc(-50vw + 50%)`
   - Thin red accent divider between Source and Result columns
   - Tree results render as SVG, aggregate results as large monospace text
   - Table results render as HTML table

5. **Added to Makefile**
   - `app-emptier-coinage` target with lib-layout and lib-selection dependencies
   - Bundles to `public/bundle.js`

### Explored But Not Pursued

- **Curly brace UI**: Mathematical notation showing tree and value results vertically, with one grayed out. Implemented but added visual complexity without proportional pedagogical value. Simplified to two-column layout.

### Files Changed

**emptier-coinage:**
- `src/Optics/Component.purs` - full optics categories, dim functions, simplified layout
- `src/Optics/PSD3View.purs` - clear before render
- `public/style.css` - full-width flexbox layout, value result styling

**Root:**
- `Makefile` - added `app-emptier-coinage` target

### Commits

- emptier-coinage: "Complete Emptier Coinage optics showcase"

### Next Steps

1. Migrate other showcases to use new library changes from this branch
2. Consider merging `feature/heterogeneous-ast` to main once validated
