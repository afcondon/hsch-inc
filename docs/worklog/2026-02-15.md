# 2026-02-15

## Session Focus

Performance optimization of minard-loader DB inserts, fixing reachability visualization regressions, and building a CLI tool for dead code analysis.

## Accomplished

### DuckDB Appender API Migration (~13x Loader Speedup)

Replaced row-by-row `INSERT OR IGNORE` prepared statements with DuckDB's native Appender API for bulk inserts. DuckDB is a columnar database that's terrible at individual row inserts but excellent at bulk loading.

- Added 8 `append_*` functions in `src/db/insert.rs` for: modules, declarations, child_declarations, snapshot_packages, package_dependencies, module_imports, function_calls, reexports
- Updated call sites in `pipeline.rs` (6), `registry/mod.rs` (6), and restructured `postload.rs` (2) with in-memory dedup via HashSet (Appender doesn't support `OR IGNORE`)
- Left `insert_package_versions` unchanged (only ~117 rows, needs `OR IGNORE` + query-back for cross-project dedup)

**Results (release build, full polyglot scan):**

| Phase | Before | After |
|---|---|---|
| Registry packages | 21.4s | ~1.5s |
| Function calls | 5.9s | <1s |
| Extra packages | 3.6s | <1s |
| Module imports | 1.3s | <0.5s |
| **Total** | **~34s** | **~3s** |

Committed as `99dea50`.

### Three Reachability Visualization Bug Fixes

After the loader changes, reachability ("dead code") visualization was broken in multiple ways. Diagnosed and fixed three independent bugs:

**Bug 1 — Git-sourced 0-module packages shadowing registry packages (server)**

The `active_packages` CTE in `getAllImports`/`getAllCalls` was picking `prelude@0.0.0` (source=git, 0 modules, from purerl-tidal project) over `prelude@6.0.2` (source=registry, 49 modules) because both had priority 1 and highest ID won. This caused 249 registry package modules to vanish from allImports entirely.

Fix: Added `AND EXISTS (SELECT 1 FROM modules m WHERE m.package_version_id = pv.id)` to both CTEs.

**Bug 2 — Module ID mismatch between endpoints (frontend)**

`listModules` (project-scoped) returns prelude modules from package_version id=25 (module id=700). `getAllImports` best_modules picks from package_version id=322 (module id=1189). `ModuleTreemapEnrichedViz` filtered imports by `moduleId`, which never matched for registry packages.

Fix: Changed import filtering from `Set.member imp.moduleId pkgModuleIds` to `Set.member imp.moduleName pkgModuleNames`.

**Bug 3 — Stale reachability cache across navigation (frontend)**

`reachabilityData` was never cleared when navigating between packages. Pressing R on prelude after viewing minard-frontend would show minard-frontend's reachability applied to prelude's modules.

Fix: Added `reachabilityData = Nothing, clusterData = Nothing` to both NavigateTo handlers in SceneCoordinator.

### App vs Library Visual Distinction

- App packages (with `bundleModule`) now render as rounded rectangles instead of circles across all three viz layers (treemap, beeswarm, bubble-pack)
- Source indicator letters ("p" for registry, "e" for extra) inside package shapes
- Peek overlay labels differ: app mode shows "MAIN"/"in use"/"dead code"; library mode shows "ENTRY POINT"/"reachable"/"UNREACHABLE"
- `isApp` field added to `PackageReachability`, `bundleModule` threaded through `PackageSetPackage` to all viz layers

### Schema Enhancement: imported_module_id

Added `imported_module_id INTEGER REFERENCES modules(id)` to `module_imports` table (schema 3.2 -> 3.3) with a final-pass resolution step after workspace refresh to fix cross-project FK references nulled by `ON DELETE SET NULL`.

### minard-reach CLI Tool

Built a zero-dependency Python CLI (`tools/minard-reach`) for querying module reachability from the server. Runs the same BFS algorithm as the frontend visualization.

```
minard-reach                     # summary table of all packages
minard-reach prelude             # detailed view with entry points and dead modules
minard-reach --json prelude      # machine-readable JSON
minard-reach --unreachable       # list all dead modules
```

Supports fuzzy package name matching, app vs library mode detection, and custom server URLs. Useful for LLM assistants and scripted analysis.

Current stats: 302/864 modules reachable (35%) across 117 packages; minard-frontend 38/46 (83%).

## Explored But Not Pursued

- **Splitting allImports/allCalls into project-scoped endpoints**: Would avoid the ID mismatch problem entirely, but the cross-project dedup is valuable for getting a unified view. Name-based filtering is the correct approach.
- **Removing debug logging from SceneCoordinator**: Left the `[SceneCoordinator]` reachability logging in place for now — it's useful for diagnosing future issues and low-cost.

## Parking Lot

- The 35% overall reachability figure is interesting but misleading — many registry packages export a broad API surface where only a subset is used by any single consumer. Per-package analysis is more meaningful.
- `frontend/frontend/` and `frontend/public/app.js` are untracked build artifacts that should probably be gitignored.
- The `imported_module_id` column could enable richer cross-module analysis in the server (join-based import resolution instead of name matching).

## Decisions Made

- **Appender over batch INSERT VALUES**: DuckDB's Appender bypasses SQL parsing entirely, making it the correct bulk-load mechanism. In-memory HashSet dedup replaces `OR IGNORE` semantics.
- **Filter by module name, not ID**: Module IDs are unstable across package versions. Module names are the stable identifier for cross-endpoint joins.
- **Clear per-package caches on navigation**: Reachability and cluster data are package-specific and must be invalidated when the user navigates to a different package.
- **Python for CLI tool**: Zero dependencies, no build step, instantly usable by LLMs. The algorithm is simple enough that reimplementing the BFS in Python (vs calling into PureScript) was the right trade-off.

## Next Session Setup

- All changes committed and pushed (3 commits: appender migration, bug fixes + visual enhancements, CLI tool)
- Servers should be started with `npm run serve:api` (port 3000) and the frontend httpd (port 8080)
- Database at `database/ce-unified.duckdb` is loaded with full polyglot scan
- The `minard-reach` tool at `tools/minard-reach` can verify reachability without starting the frontend
