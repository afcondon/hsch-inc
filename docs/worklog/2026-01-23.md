# Worklog: 2026-01-23

## Session 1: PSD3 Interpreter Systems Deep Dive

### Session Focus
Comprehensive review of the interpreter/AST systems across psd3-selection, psd3-simulation, and psd3-layout to understand the current design, identify tech debt, and document for future maintenance.

### Accomplished

- **Created KB architecture document**: `docs/kb/architecture/psd3-interpreter-systems.md`
  - Documents the three distinct patterns across libraries
  - Maps all 10+ interpreters in psd3-selection
  - Explains the Finally Tagless expression system
  - Covers psd3-simulation's Effect-based adapter pattern
  - Notes psd3-layout is purely algorithmic (no interpreters)

- **Identified confirmed dead code**: `PSD3/Config/*` modules in psd3-simulation have zero usages anywhere in the codebase

- **Updated KB index**: Added new architecture document

- **Reviewed registry-dev#354**: Confirmed our alternate backend workarounds align with community discussion (logged in yesterday's worklog)

### Tech Debt Identified (Cleanup Deferred)

The following cleanup was planned but deferred due to concurrent work by another Claude session:

#### 1. Delete Dead Modules (psd3-simulation)
```
visualisation libraries/purescript-psd3-simulation/src/PSD3/Config/
├── Force.purs      # DEAD - zero usages
├── Scene.purs      # DEAD - zero usages
└── Apply.purs      # DEAD - zero usages
```
**Action**: `rm -rf "visualisation libraries/purescript-psd3-simulation/src/PSD3/Config"`

#### 2. Remove Commented Code (psd3-layout)
**File**: `visualisation libraries/purescript-psd3-layout/src/DataViz/Layout/Hierarchy/Pack.purs`
**Lines**: 205-214 (commented `shortenChain` function)
**Action**: Delete the commented block

#### 3. Fix XML Escaping (psd3-selection)
**File**: `visualisation libraries/purescript-psd3-selection/src/PSD3/Expr/Interpreter/PureSVG.purs`
**Line**: 188
**Current**: `escapeXml = identity` with TODO comment
**Action**: Implement proper escaping for `<`, `>`, `&`, `"`, `'`

#### 4. Replace unsafePerformEffect (psd3-layout)
**File**: `visualisation libraries/purescript-psd3-layout/src/DataViz/Layout/Sankey/Compute.purs`
**Line**: 28
**Current**: Uses `unsafePerformEffect` for debug logging
**Action**: Replace with `Debug.Trace` or make logging configurable

### Key Design Insights

1. **Three patterns, not one**: Each library uses a different approach suited to its needs
   - psd3-selection: Finally Tagless for multi-interpretation
   - psd3-simulation: Effect-based for performance in hot path
   - psd3-layout: Pure functions, no interpretation overhead

2. **Coordinator lives in wrong place**: `PSD3.Transition.Coordinator` is in psd3-selection but used by psd3-simulation

3. **Legacy superseded**: `PSD3.Config.*` was replaced by `PSD3.ForceEngine.Setup` but never deleted

### Reports Generated

- `docs/kb/architecture/psd3-interpreter-systems.md` - Comprehensive architecture reference

---

## Session 2: FP Police Skill Creation

### Session Focus
Create a new Claude Code skill for auditing the codebase for functional programming violations and accumulated shortcuts.

### Accomplished

- **Created `/fp-police` skill**: `.claude/commands/fp-police.md`
  - Audits for FFI in wrong places (demos, showcases)
  - Checks for unsafe operations outside core libraries
  - Finds Internal module imports in application code
  - Locates deprecated code and backward compatibility hacks
  - Detects code smells (console.log, partial functions, error throwing)

### Skill Features

**Usage modes:**
- `/fp-police` - Full audit
- `/fp-police quick` - Most common violations only
- `/fp-police <path>` - Specific directory
- `/fp-police ffi` - FFI audit only
- `/fp-police unsafe` - Unsafe operations only
- `/fp-police deprecated` - Deprecated code only

**Violation categories:**
- **A**: FFI in Wrong Places (showcases, demos)
- **B**: Unsafe Operations (unsafeCoerce, unsafePartial, Refs)
- **C**: API Violations (Internal imports, direct D3 FFI)
- **D**: Deprecated Code (TODOs, legacy shims, dead code)
- **E**: Code Smells (console.log, partial functions)

**Context-aware exceptions:**
- psd3-selection/simulation coupling
- Effect.Ref in hot paths
- Node.js dashboard FFI

### Files Created

- `.claude/commands/fp-police.md` - The skill definition

---

## Session 3: ForcePlayground Migration to runSimulation API

### MILESTONE: ForcePlayground Migrated Successfully

Migrated ForcePlayground from low-level `PSD3.Kernel.D3.Simulation` wrapper to high-level `runSimulation` API. This validates the high-level API is production-ready.

**Key achievements:**
- All force configuration via Setup DSL (manyBody, collide, link, positionX/Y)
- Force toggling via `handle.updateSetup`
- Halogen subscriptions via `toHalogenEmitter`
- Position interpolation via `handle.interpolatePositions` (for quadrant layout)
- Node pinning via `handle.pinNodes`/`unpinNodes`

**API additions to SimulationHandle:**
```purescript
interpolatePositions :: PositionMap -> PositionMap -> Number -> Effect Unit
pinNodes :: Effect Unit
unpinNodes :: Effect Unit
```

### Bug Fixes Discovered During Migration

1. **Collision force not applying** (CRITICAL)
   - **Root cause**: D3 force simulation requires `fx/fy/vx/vy/index` fields on nodes
   - **Fix**: Added `Core.initializeNodes` call in `applySetupWithData`
   - **Location**: `PSD3.ForceEngine.Setup.purs`

2. **Race condition on force toggle**
   - **Symptom**: CPU spikes, animation stopping when toggling forces
   - **Root cause**: Old coordinator wasn't stopped before creating new one
   - **Fix**: `updateSetup` and `start` now stop existing coordinator first
   - **Location**: `PSD3.Simulation.purs`

### Files Changed

**website repo (f158c65):**
- `ForcePlayground.purs` - Rewritten to use high-level API
- `Simple.purs` - Rewritten (merged SimpleV2)
- Deleted: `ForcePlaygroundV2.purs`, `SimpleV2.purs`, `Simple.js`

**simulation library (7189771):**
- `PSD3.Simulation.purs` - Added interpolatePositions, pinNodes, unpinNodes; fixed coordinator lifecycle
- `PSD3.ForceEngine.Setup.purs` - Added Core.initializeNodes in applySetupWithData

---

## Next Session: Fix Code Explorer Collision Forces

### Assessment: Just Rebuild - No Code Changes Needed

The CE2 beeswarm visualizations already use `runSimulation` correctly. The collision force bug was in the library (missing `Core.initializeNodes`), not in the usage pattern.

### CE2 Files Using runSimulation

| File | Usage Pattern | Needs Changes? |
|------|---------------|----------------|
| `BeeswarmViz.purs` | Basic runSimulation, no handle methods | No |
| `PackageSetBeeswarm.purs` | runSimulation + handle.stop | No |
| `CirclePackViz.purs` | runSimulation, no handle methods | No |

### Why No Code Changes Needed

1. **Collision fix is internal**: The `Core.initializeNodes` fix is inside `applySetupWithData` - called automatically by `runSimulation`

2. **No updateSetup usage**: CE2 doesn't toggle forces dynamically, so won't hit the coordinator lifecycle issue

3. **Workspace path**: CE2's `spago.yaml` references local library:
   ```yaml
   psd3-simulation:
     path: "../../visualisation libraries/purescript-psd3-simulation"
   ```

### Steps to Fix Code Explorer

```bash
# 1. Rebuild CE2 (picks up patched library automatically)
cd showcases/corrode-expel
make ce2-website  # or: cd ce2-website && spago build

# 2. Test locally
/deploy code-explorer local

# 3. Verify collision forces work
# - Load beeswarm view
# - Circles should NOT overlap (collision force working)
# - Compare with ForcePlayground behavior

# 4. If working, deploy
/deploy ce-frontend
```

### Verification Checklist

- [ ] CE2 builds without errors
- [ ] BeeswarmViz: circles don't overlap (collision working)
- [ ] PackageSetBeeswarm: circles don't overlap
- [ ] CirclePackViz: force simulation runs, packages separate
- [ ] No console errors about missing fields
- [ ] Performance acceptable (no CPU spikes)

### Potential Issues to Watch For

1. **Different node type structure**: If CE2 nodes have unusual field patterns, verify `Core.initializeNodes` handles them

2. **Event handling**: CE2 uses `subscribe` not `toHalogenEmitter`. Both should work but verify tick events fire

---

## Decisions Made

1. **Position interpolation in handle**: Added to SimulationHandle rather than separate utility
2. **Coordinator lifecycle**: Stop-before-start pattern for both updateSetup and start
3. **Merge V2 into V1**: Rather than keeping parallel implementations, merged after validation

## Parking Lot

- Consider adding `withIterations` to collide force for stronger separation (CE2 might benefit)
- Documentation for the new handle methods (interpolatePositions, pinNodes, unpinNodes)
- Run deferred cleanup from Session 1 when safe
