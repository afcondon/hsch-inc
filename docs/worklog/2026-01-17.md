# Worklog: 2026-01-17

## Session Focus
Investigate and fix PSD3 selection bug causing `renderTree: appendChild returned empty selection` error in nested Halogen child components (InteractiveParadoxCard).

## Accomplished

- **Fixed InteractiveParadoxCard rendering**: Rewrote the component to use pure Halogen SVG (`Halogen.Svg.Elements`/`Halogen.Svg.Attributes`) instead of PSD3. Charts now render correctly.

- **Root cause analysis of PSD3 selection bug**: Identified why PSD3's `select` fails for nested Halogen components:
  1. `select` (Operations.purs:82-100) queries the entire document via `querySelector`
  2. When nested child components run `Initialize`, their parent's slot may not have finished mounting DOM
  3. Every existing PSD3 visualization uses a 50ms delay hack (`liftAff $ delay (Milliseconds 50.0)`) before calling `select`
  4. This delay is unreliable for deeply nested components

- **Identified proper fix**: PSD3 already has `selectElement` which takes an Element directly. Combined with Halogen's DOM ref mechanism (`H.RefLabel`, `H.getRef` - not `Effect.Ref`), this eliminates the timing hack entirely.

## Explored But Not Pursued

- **Refactoring all existing components to use refs**: The current delay hack works for top-level components. Refactoring would be beneficial but is lower priority than shipping the Simpson's Paradox demo.

- **Adding a PSD3 Halogen integration module**: A helper like `withContainerRef` would make the ref pattern easier, but this is a future enhancement.

## Parking Lot

- Consider whether `select` should throw a more informative error when element not found

## TODO (High Priority)

- **Fix PSD3 Halogen integration pattern**: Replace the 50ms delay hack with proper Halogen DOM refs (`H.RefLabel` + `H.getRef`) and `selectElement`. This is the first time we've properly componentized PSD3 visualizations (multiple instances of the same component), which is why the timing bug wasn't encountered before. All previous uses were one-off page-level components where the delay happened to work.

- **Document the ref + `selectElement` pattern** in PSD3's documentation as the canonical way to integrate with Halogen

## Decisions Made

- **Keep InteractiveParadoxCard as pure Halogen SVG**: For simple static charts that redraw on slider change, pure Halogen is cleaner than PSD3. Reserve PSD3 for visualizations needing force simulation, transitions, or data joins.

- **Don't remove the 50ms delay from existing components**: It works and changing it risks breaking things. New components should use the ref pattern instead.

## Reports Generated

- Analysis captured in this worklog (no separate report needed)

## Next Session Setup

The proper pattern for PSD3 + Halogen integration:

```purescript
-- 1. Define a ref label
chartRef :: H.RefLabel
chartRef = H.RefLabel "chart-container"

-- 2. Attach ref in render
render state =
  HH.div [ HP.ref chartRef ] []

-- 3. In Initialize, get element via ref (no delay needed!)
handleAction = case _ of
  Initialize -> do
    maybeElem <- H.getRef chartRef
    for_ maybeElem \htmlElem -> do
      let elem = HTMLElement.toElement htmlElem
      liftEffect $ runD3v2M do
        container <- selectElement elem
        _ <- renderTree container myTree
        pure unit
```

Key files:
- `visualisation libraries/purescript-psd3-selection/src/PSD3/Internal/Selection/Operations.purs` - `select` at line 82, `selectElement` at line 111
- `site/website/src/Viz/Simpsons/Components.purs` - all components use 50ms delay pattern
- `site/website/src/Viz/Simpsons/InteractiveParadoxCard.purs` - now uses pure Halogen SVG

---

## Session 2: Simpson's Paradox Page Fixes (continued)

### Accomplished

- **Fixed SVG wrapper issue for all chart components**: Identified that PSD3 tree elements like `scatterChartStatic`, `lineChartStatic`, etc. return `<g>` elements, not `<svg>`. When rendered directly into a `<div>` container, they have no dimensions. Fixed by creating proper SVG wrappers with explicit `width`, `height`, and `viewBox` in:
  - `donutChartsComponent`
  - `lineChartComponent`
  - `scatterChartComponent`

- **Fixed DataTable component**: The component was rendering an empty div, but `initDataTable` expected container elements with IDs like `#row-0-male-applied`. Rewrote the render function to create an HTML table structure with proper cell IDs that `initDataTable` can select and fill with bar charts and mini donuts.

- **Added CSS for data table cells**: Added styles for `.bar-cell`, `.donut-cell`, `.dept-cell`, `.header-group`, and `.subheaders` classes used by the new table structure.

### Pattern Established

When wrapping PSD3 Tree elements that return `<g>` groups (not `<svg>`), always create an SVG wrapper:

```purescript
let svgTree :: T.Tree Unit
    svgTree =
      T.named SVG "chart-svg"
        [ evalAttr "width" (lit config.width)
        , evalAttr "height" (lit config.height)
        , evalAttrStr "viewBox" (str ("0 0 " <> show config.width <> " " <> show config.height))
        , evalAttrStr "class" (str "chart-svg")
        ]
        `T.withChildren`
          [ T.elem Group
              [ evalAttrStr "transform" (str ("translate(" <> show margin.left <> "," <> show margin.top <> ")")) ]
              `T.withChildren` [ chartContent ]
          ]
_ <- renderTree container svgTree
```

### Files Modified

- `site/website/src/Viz/Simpsons/Components.purs` - Fixed all chart components
- `site/website/public/psd3.css` - Added data table cell styles

---

## Session 3: Library Site Screenshot Links & Demo Deployment

### Session Focus
Add clickable screenshot links to library landing pages, connect them to their respective demo apps, and deploy the full stack to MacMini.

### Accomplished

- **Fixed broken showcase links on homepage**: Optic Menagerie and Morphism Zoo were reloading the homepage because they weren't separate Docker services. Added them:
  - Created `showcases/emptier-coinage/Dockerfile` for Optic Menagerie
  - Created `showcases/psd3-prim-zoo-mosh/Dockerfile` for Morphism Zoo
  - Added `optics` and `zoo` services to docker-compose.yml
  - Added `OpticsFrontend` and `ZooFrontend` routes to edge router

- **Fixed Simpson's Paradox link**: Changed from direct path `/simpsons-v2` to hash route `#/simpsons-v2` (SPA uses hash-based routing)

- **Fixed acronym logotype positioning**: Moved down and left as requested. Used `transform: translateX(-4rem) rotate(-12deg)` instead of margin-left (margins don't work well with rotated elements in grid layouts)

- **Added screenshotLink function to LibShell**: New function `screenshotLink :: String -> String -> String -> HH.HTML w i` that renders a clickable screenshot image linking to a demo app, with hover effect.

- **Added CSS for screenshot links**: `.lib-screenshot-link` class with shadow, border-radius, and hover lift effect

- **Updated library sites to use screenshot links**:
  - `psd3-graph` → `/honeycomb/` (Honeycomb Puzzle demo)
  - `psd3-simulation` → `/#/force-playground` (Force Playground on main site)
  - `psd3-layout` → `/layouts/` (Layout Gallery demo - allergy-outlay)
  - `psd3-music` → `/anscombe/` (Anscombe's Quartet demo)

- **Added new demo services to Docker stack**:
  - `honeycomb` service from `showcases/psd3-honeycomb/`
  - `anscombe` service from `visualisation libraries/psd3-anscombe-quartet/`
  - `layouts` service from `showcases/allergy-outlay/`
  - Created Dockerfiles for each

- **Updated edge router (scuppered-ligature)**:
  - Added `HoneycombFrontend`, `AnscombeFrontend`, `LayoutsFrontend` upstreams
  - Added routes for `/honeycomb/`, `/anscombe/`, `/layouts/`
  - Removed `LibTree` (lib-tree deleted)

- **Fixed nginx.conf issues**:
  - Removed stale `landing:80` upstream that was preventing edge from starting
  - Changed default upstream from `landing:8080` to `website:80`
  - Added all new upstreams (optics, zoo, honeycomb, anscombe, layouts, lib-sites)

- **Deleted lib-tree site**:
  - Removed `site/lib-tree/` directory
  - Removed from docker-compose.yml
  - Removed from edge router
  - Removed from Makefile targets

- **Deployed everything to MacMini** (100.101.177.83):
  - All endpoints verified returning 200

### Files Modified/Created

**Created:**
- `showcases/emptier-coinage/Dockerfile`
- `showcases/psd3-prim-zoo-mosh/Dockerfile`
- `showcases/psd3-honeycomb/Dockerfile`
- `visualisation libraries/psd3-anscombe-quartet/Dockerfile`
- `showcases/allergy-outlay/Dockerfile`

**Modified:**
- `docker-compose.yml` - Added optics, zoo, honeycomb, anscombe, layouts services; removed lib-tree
- `showcases/scuppered-ligature/src/Edge/Router.purs` - Added new upstreams, removed LibTree
- `showcases/scuppered-ligature/nginx.conf` - Fixed upstreams, removed landing
- `site/lib-shell/src/LibShell.purs` - Added `screenshotLink` function
- `site/lib-shell/public/lib-shell.css` - Added screenshot link styles
- `site/lib-graph/src/Main.purs` - Changed to screenshotLink → /honeycomb/
- `site/lib-simulation/src/Main.purs` - Changed to screenshotLink → /#/force-playground
- `site/lib-layout/src/Main.purs` - Changed to screenshotLink → /layouts/
- `site/lib-music/src/Main.purs` - Changed to screenshotLink → /anscombe/
- `site/website/src/Component/Home.purs` - Fixed Simpson's link to use hash route
- `site/website/public/psd3.css` - Fixed logotype positioning
- `Makefile` - Removed lib-site-tree target

**Deleted:**
- `site/lib-tree/` (entire directory)

### Decisions Made

- **Screenshots copied to each lib-site's public folder**: Rather than referencing screenshots from the main website (which would require cross-container URL resolution), copied `demo.jpeg` to each lib-site's public folder for self-contained deployment.

- **Force playground links to main site hash route**: Since force-playground is a route within the main SPA (not a standalone app), the lib-simulation link uses `/#/force-playground` which navigates to the main site.

- **Layout gallery is standalone**: Unlike force-playground, the layout gallery (allergy-outlay) is a separate showcase app at `/layouts/`.

### Next Session Setup

**Plan for tomorrow:**
1. Write up the individual library pages on the site (replace lorem ipsum with real content)
2. Work on tree-builder showcase for the selection library
3. Begin to tackle the documentation
4. Audit the usage of psd3 throughout the site to ensure exemplary code
5. Replace the banner with "polyglot purescript" and make "PS<$>D3" a secondary marque for the libraries
6. Work on code-explorer
7. Audit for dead code
8. Audit for unauthorized FFI, Effect.Ref etc

**Parking lot (from Session 4):**
- Make demo apps consistent in name, location, and routing. Specifically: `tree-builder` and `force-playground` should be separate app bundles in the `showcases/` directory structure (like `honeycomb`, `anscombe`, `layouts`), not routes within the main SPA.
- **Bidirectional DAG ↔ Graph converter**: Add `toGraph :: DAGTree -> Graph` and `fromGraph :: Graph -> Maybe DAGTree` (returns Nothing if graph has cycles). This would live in psd3-graph alongside DAGTree.
- **Clarify psd3-layout README**: It uses `Data.Tree` from `tree-rose` (re-exported via psd3-tree), not a custom tree structure. The dependency chain is: psd3-layout → psd3-tree → tree-rose.
- **DAGTree is already shown** at `/#/tour/graph-algorithms` but could be more prominently featured - perhaps its own showcase or linked from psd3-graph landing page.

**Key deployed endpoints:**
- `/` - Main Polyglot PureScript site
- `/psd3/selection/`, `/psd3/simulation/`, `/psd3/layout/`, `/psd3/graph/`, `/psd3/music/` - Library landing pages
- `/honeycomb/`, `/anscombe/`, `/layouts/` - Demo apps linked from library pages
- `/optics/`, `/zoo/` - Additional showcases
