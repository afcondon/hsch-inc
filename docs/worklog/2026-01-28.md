# Worklog: 2026-01-28

## Accomplished

### HATS Migration Complete for TourMotionScrolly

The `/tour/scrolly2` page is now fully HATS-based with tick-driven transitions, covering all major visualization use cases:

1. **Single element animations** (steps 1-2) - opacity fading, position movement
2. **Multi-element synchronized animations** (step 3) - lockstep movement
3. **Staggered animations** (step 4) - wave effect with per-element delay
4. **GUP circles** (step 5) - enter/update/exit with color coding (green→gray→brown)
5. **GUP letters** (step 6) - text elements with bounce-in/drop-out transitions
6. **Tree ↔ Dendrogram** (step 8) - layout algorithm transitions
7. **Force-directed graph** (step 9) - LesMis with simulation + drag + zoom

### Bug Fixes

1. **Exit transitions not animating**: Fixed order of operations in `InterpreterTick.purs` - was applying exit attrs BEFORE reading current values for transitions. Now creates transitions first (capturing current "from" values), then applies only non-numeric attrs.

2. **Container not clearing between steps**: `clearViz` was using `rerender` with empty tree, but interpreter reuses existing elements. Changed to use `clearContainer` which actually removes DOM children.

### Route Changes

- `/tour/scrolly2` → Now serves HATS tick-driven version (was Web Animations API)
- `/tour/scrolly2-legacy` → Old Web Animations API version (for comparison)

### Documentation

Created `docs/modules/ROOT/pages/how-to/clearing-containers.adoc` explaining:
- When to use GUP (within a fold, for data changes)
- When to use `clearContainer` (between different tree structures)
- Common mistake of using `rerender` with empty tree

## Decisions Made

1. **Unified tick architecture confirmed**: The tick-driven transition system successfully handles both:
   - GUP transitions (enter/update/exit)
   - Force simulation animations
   - Layout algorithm transitions

   No D3 transitions or Web Animations API needed.

2. **clearContainer vs GUP**: These serve different purposes and both are needed:
   - GUP: manages element lifecycle within a fold (keyed diffing)
   - clearContainer: clears DOM when tree structure changes completely

## Files Modified

**Library (psd3-selection):**
- `src/PSD3/HATS/InterpreterTick.purs` - Fixed exit transition ordering
- `docs/modules/ROOT/pages/how-to/clearing-containers.adoc` - New documentation

**Website:**
- `src/Component/Tour/TourMotionAnimationsHATS.purs` - Use `clearContainer` for clearViz
- `src/Component/Tour/TourMotionScrollyHATS.purs` - Clear container on step change
- `src/RoutingDSL.purs` - Swap scrolly2 routes (HATS is now default)

---

## Session 2: Library Extraction

### Extracted psd3-transitions Library

Moved pure transition primitives from psd3-selection to new `psd3-transitions` library, mirroring D3's structure (d3-ease, d3-interpolate, d3-transition).

**New library contains:**
- `Tick.purs` - Progress type, lerp, easing functions
- `Easing.purs` - EasingType enum with all D3 easings
- `Interpolate.purs` - Point, RGB, HSL interpolation
- `Engine.purs` - TransitionSpec, TransitionState, tick-driven state machine
- `Coordinator.purs` - RAF loop management
- `RAF.purs` + `RAF.js` - requestAnimationFrame FFI

**Dependency structure:**
```
psd3-transitions (new, pure)
       ↑
psd3-selection (depends on transitions)
       ↑
psd3-simulation, website, etc.
```

**What stays in psd3-selection:**
- `PSD3/Internal/Transition/` - DOM/selection integration (Types, Manager, Scene, FFI)
- `PSD3/HATS/Transitions.purs` - HATS-specific transition orchestration

### Files Created
- `visualisation libraries/purescript-psd3-transitions/` - New library
- `visualisation libraries/purescript-psd3-transitions/spago.yaml`
- `visualisation libraries/purescript-psd3-transitions/src/PSD3/Transition/*.purs`

### Files Modified
- `visualisation libraries/purescript-psd3-selection/spago.yaml` - Added psd3-transitions dependency
- `site/website/spago.yaml` - Added psd3-transitions to extraPackages
- Removed `visualisation libraries/purescript-psd3-selection/src/PSD3/Transition/`

---

## Session 3: Brush Coordination for HATS

### Context

Investigated converting the penguins SPLOM (`/splom`) to HATS to test edge cases. Found that:
- The existing SPLOM uses old Tree API (`T.named`, `T.elem`, `renderTree`)
- It has brush interaction that was implemented imperatively (post-render attachment)
- The existing `PSD3.Interaction.Coordinated` module already has infrastructure for brush + hover coordination

### Added Brush Support to HATS

Extended HATS to support coordinated interaction (brush + hover) with two new behavior types:

**1. `ThunkedCoordinatedInteraction`** - Full interaction response
```purescript
onCoordinatedInteraction
  { identify: pt.id
  , respond: \trigger -> case trigger of
      HoverTrigger id -> if pt.id == id then Primary else Dimmed
      BrushTrigger box -> if pointInBox pt.pos box then Selected else Dimmed
      ClearTrigger -> Neutral
      _ -> Neutral
  , position: Just pt.pos
  , group: Just "scatter-plot"
  }
```

**2. `ThunkedBrush`** - Attaches brush overlay to element
```purescript
onBrush
  { extent: { x0: 0.0, y0: 0.0, x1: 400.0, y1: 300.0 }
  , group: Just "scatter-plot"
  }
```

### How It Works

1. Elements register with `onCoordinatedInteraction` specifying how they respond to any trigger
2. A brush overlay attached with `onBrush` emits `BrushTrigger` on drag
3. All registered elements receive the trigger and get CSS classes:
   - `coord-primary` - direct target
   - `coord-related` - related elements
   - `coord-selected` - inside brush region
   - `coord-dimmed` - unrelated

This pattern mirrors hover highlighting but extends to brush selection.

### Files Modified

**`src/PSD3/HATS.purs`:**
- Added `ThunkedCoordinatedInteraction` behavior type
- Added `ThunkedBrush` behavior type
- Added `onCoordinatedInteraction` smart constructor
- Added `onBrush` smart constructor
- Import `InteractionTrigger`, `InteractionState`, `BoundingBox` from Coordinated

**`src/PSD3/HATS/InterpreterTick.purs`:**
- Added `interactionStateToInt` conversion function
- Added handler cases for new behavior types
- Added FFI declarations for `attachCoordinatedInteractionThunked` and `attachCoordinatedBrushThunked`

**`src/PSD3/HATS/InterpreterTick.js`:**
- Added `coordInteractionRegistry` for tracking elements
- Added `applyCoordInteraction` function
- Added `attachCoordinatedInteractionThunked` FFI
- Added `attachCoordinatedBrushThunked` FFI (implements native brush with pointer events)

### Architecture Notes

- Uses native pointer events for brush (no D3 brush dependency)
- Separate registry from HATS hover highlighting (which uses `hatsHighlightRegistry`)
- CSS classes: `coord-primary`, `coord-selected`, `coord-dimmed` (different from `highlight-*` classes)
- The Coordinated module exports `InteractionTrigger(..)`, `InteractionState(..)`, and `BoundingBox` for custom respond functions

### Next Steps

1. **Create HATS SPLOM**: Convert the penguins SPLOM to use the new HATS brush infrastructure
2. **Test performance**: Verify that brush updates at interactive speeds (~60fps) with ~3600 circles
3. **Document the pattern**: Add how-to for HATS brush coordination

## Next Session Setup

Ready to convert SPLOM to HATS with brush support:
- Infrastructure is complete in psd3-selection
- Website builds successfully
- Need to create `Viz/SPLOM/SPLOMHATS.purs` using new brush behaviors
