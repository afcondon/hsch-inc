// Generated by purs version 0.15.15
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_State from "../Control.Monad.State/index.js";
import * as Control_Monad_State_Class from "../Control.Monad.State.Class/index.js";
import * as Control_Monad_State_Trans from "../Control.Monad.State.Trans/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_EuclideanRing from "../Data.EuclideanRing/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Identity from "../Data.Identity/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Number from "../Data.Number/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Ordering from "../Data.Ordering/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Set from "../Data.Set/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as DataViz_Layout_Sankey_Types from "../DataViz.Layout.Sankey.Types/index.js";
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(DataViz_Layout_Sankey_Types.ordNodeID);
var insert = /* #__PURE__ */ Data_Set.insert(DataViz_Layout_Sankey_Types.ordNodeID);
var insert1 = /* #__PURE__ */ Data_Map_Internal.insert(DataViz_Layout_Sankey_Types.ordNodeID);
var bindStateT = /* #__PURE__ */ Control_Monad_State_Trans.bindStateT(Data_Identity.monadIdentity);
var bind = /* #__PURE__ */ Control_Bind.bind(bindStateT);
var monadStateStateT = /* #__PURE__ */ Control_Monad_State_Trans.monadStateStateT(Data_Identity.monadIdentity);
var get = /* #__PURE__ */ Control_Monad_State_Class.get(monadStateStateT);
var lookup1 = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordString);
var modify_ = /* #__PURE__ */ Control_Monad_State_Class.modify_(monadStateStateT);
var insert2 = /* #__PURE__ */ Data_Map_Internal.insert(Data_Ord.ordString);
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var min = /* #__PURE__ */ Data_Ord.min(Data_Ord.ordNumber);
var max = /* #__PURE__ */ Data_Ord.max(Data_Ord.ordInt);
var eq1 = /* #__PURE__ */ Data_Eq.eq(DataViz_Layout_Sankey_Types.eqNodeID);
var append1 = /* #__PURE__ */ Data_Semigroup.append(Data_Ordering.semigroupOrdering);
var compare = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordNumber);
var compare1 = /* #__PURE__ */ Data_Ord.compare(DataViz_Layout_Sankey_Types.ordLinkID);
var div1 = /* #__PURE__ */ Data_EuclideanRing.div(Data_EuclideanRing.euclideanRingInt);
var max1 = /* #__PURE__ */ Data_Ord.max(Data_Ord.ordNumber);
var member = /* #__PURE__ */ Data_Set.member(DataViz_Layout_Sankey_Types.ordNodeID);
var union = /* #__PURE__ */ Data_Set.union(DataViz_Layout_Sankey_Types.ordNodeID);
var fromFoldable = /* #__PURE__ */ Data_Set.fromFoldable(Data_Foldable.foldableArray)(DataViz_Layout_Sankey_Types.ordNodeID);
var eq2 = /* #__PURE__ */ Data_Eq.eq(DataViz_Layout_Sankey_Types.eqLinkID);
var mod = /* #__PURE__ */ Data_EuclideanRing.mod(Data_EuclideanRing.euclideanRingInt);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit)(bindStateT);
var for_ = /* #__PURE__ */ Data_Foldable.for_(/* #__PURE__ */ Control_Monad_State_Trans.applicativeStateT(Data_Identity.monadIdentity))(Data_Foldable.foldableArray);
var unionInsert = function (sid) {
    return function (tid) {
        return function (deps) {
            var targetSet = (function () {
                var v = lookup(sid)(deps);
                if (v instanceof Data_Maybe.Nothing) {
                    return Data_Set.singleton(tid);
                };
                if (v instanceof Data_Maybe.Just) {
                    return insert(tid)(v.value0);
                };
                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 98, column 5 - line 100, column 47): " + [ v.constructor.name ]);
            })();
            return insert1(sid)(targetSet)(deps);
        };
    };
};
var processCSVLink = function (link) {
    return bind(get)(function (model) {
        var t = lookup1(link.t)(model.nodeNameToID);
        var s = lookup1(link.s)(model.nodeNameToID);
        var v = (function () {
            if (s instanceof Data_Maybe.Just && t instanceof Data_Maybe.Just) {
                return {
                    nodeCount: model.nodeCount,
                    sid: s.value0,
                    tid: t.value0,
                    newNodes: [  ]
                };
            };
            if (s instanceof Data_Maybe.Just && t instanceof Data_Maybe.Nothing) {
                return {
                    nodeCount: model.nodeCount + 1 | 0,
                    sid: s.value0,
                    tid: model.nodeCount,
                    newNodes: [ model.nodeCount ]
                };
            };
            if (s instanceof Data_Maybe.Nothing && t instanceof Data_Maybe.Just) {
                return {
                    nodeCount: model.nodeCount + 1 | 0,
                    sid: model.nodeCount,
                    tid: t.value0,
                    newNodes: [ model.nodeCount ]
                };
            };
            if (s instanceof Data_Maybe.Nothing && t instanceof Data_Maybe.Nothing) {
                return {
                    nodeCount: model.nodeCount + 2 | 0,
                    sid: model.nodeCount,
                    tid: model.nodeCount + 1 | 0,
                    newNodes: [ model.nodeCount, model.nodeCount + 1 | 0 ]
                };
            };
            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 114, column 7 - line 124, column 177): " + [ s.constructor.name, t.constructor.name ]);
        })();
        return modify_(function (v1) {
            var $120 = {};
            for (var $121 in v1) {
                if ({}.hasOwnProperty.call(v1, $121)) {
                    $120[$121] = v1[$121];
                };
            };
            $120.linkCount = model.linkCount + 1 | 0;
            $120.nodeCount = v.nodeCount;
            $120.nodeNameToID = insert2(link.s)(v.sid)(insert2(link.t)(v.tid)(model.nodeNameToID));
            $120.nodeIDToName = insert1(v.sid)(link.s)(insert1(v.tid)(link.t)(model.nodeIDToName));
            $120.nodeOrder = append(model.nodeOrder)(v.newNodes);
            $120.deps = unionInsert(v.sid)(v.tid)(model.deps);
            $120.sped = unionInsert(v.tid)(v.sid)(model.sped);
            $120.sankeyLinks = Data_Array.snoc(model.sankeyLinks)(DataViz_Layout_Sankey_Types.initialiseSankeyLink({
                source: v.sid,
                target: v.tid,
                value: link.v,
                id: model.linkCount
            }));
            return $120;
        });
    });
};
var initializeNodeBreadths = function (nodes) {
    return function (_links) {
        return function (_config) {
            return function (padding) {
                return function (y0) {
                    return function (y1) {
                        var positionLayer = function (ky) {
                            return function (padding1) {
                                return function (yStart) {
                                    return function (layerNodes) {
                                        var stacked = Data_Array.foldl(function (acc) {
                                            return function (node) {
                                                var nodeHeight = node.value * ky;
                                                var positioned = {
                                                    value: node.value,
                                                    color: node.color,
                                                    depth: node.depth,
                                                    index: node.index,
                                                    layer: node.layer,
                                                    name: node.name,
                                                    nodeHeight: node.nodeHeight,
                                                    sourceLinks: node.sourceLinks,
                                                    targetLinks: node.targetLinks,
                                                    x0: node.x0,
                                                    x1: node.x1,
                                                    y0: acc.y,
                                                    y1: acc.y + nodeHeight
                                                };
                                                return {
                                                    nodes: Data_Array.snoc(acc.nodes)(positioned),
                                                    y: acc.y + nodeHeight + padding1
                                                };
                                            };
                                        })({
                                            nodes: [  ],
                                            y: yStart
                                        })(layerNodes);
                                        var extraSpacing = ((y1 - stacked.y) + padding1) / (Data_Int.toNumber(Data_Array.length(layerNodes)) + 1.0);
                                        var adjusted = Data_Array.mapWithIndex(function (i) {
                                            return function (node) {
                                                var shift = extraSpacing * Data_Int.toNumber(i + 1 | 0);
                                                return {
                                                    color: node.color,
                                                    depth: node.depth,
                                                    index: node.index,
                                                    layer: node.layer,
                                                    name: node.name,
                                                    nodeHeight: node.nodeHeight,
                                                    sourceLinks: node.sourceLinks,
                                                    targetLinks: node.targetLinks,
                                                    value: node.value,
                                                    x0: node.x0,
                                                    x1: node.x1,
                                                    y0: node.y0 + shift,
                                                    y1: node.y1 + shift
                                                };
                                            };
                                        })(stacked.nodes);
                                        return adjusted;
                                    };
                                };
                            };
                        };
                        var calculateKy = function (layers) {
                            return function (height) {
                                return function (padding1) {
                                    var scaleForLayer = function (layerNodes) {
                                        var totalValue = Data_Array.foldl(function (sum) {
                                            return function (node) {
                                                return sum + node.value;
                                            };
                                        })(0.0)(layerNodes);
                                        var numNodes = Data_Int.toNumber(Data_Array.length(layerNodes));
                                        var availableHeight = height - (numNodes - 1.0) * padding1;
                                        var $127 = totalValue > 0.0;
                                        if ($127) {
                                            return availableHeight / totalValue;
                                        };
                                        return 1.0;
                                    };
                                    var scales = map(scaleForLayer)(layers);
                                    var nonEmptyScales = Data_Array.filter(function (s) {
                                        return s > 0.0;
                                    })(scales);
                                    var v = Data_Array.head(nonEmptyScales);
                                    if (v instanceof Data_Maybe.Just) {
                                        return Data_Array.foldl(min)(v.value0)(nonEmptyScales);
                                    };
                                    if (v instanceof Data_Maybe.Nothing) {
                                        return 1.0;
                                    };
                                    throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 412, column 7 - line 414, column 23): " + [ v.constructor.name ]);
                                };
                            };
                        };
                        var totalHeight = y1 - y0;
                        var maxLayer = Data_Array.foldl(function (acc) {
                            return function (node) {
                                return max(acc)(node.layer);
                            };
                        })(0)(nodes);
                        var layers = map(function (layerIdx) {
                            return Data_Array.filter(function (node) {
                                return node.layer === layerIdx;
                            })(nodes);
                        })(Data_Array.range(0)(maxLayer));
                        var ky = calculateKy(layers)(totalHeight)(padding);
                        var positionedLayers = map(positionLayer(ky)(padding)(y0))(layers);
                        var positioned = Data_Array.concat(positionedLayers);
                        return positioned;
                    };
                };
            };
        };
    };
};
var initialiseSankeyNodes = /* #__PURE__ */ bind(get)(function (model) {
    var sankeyNodes = Data_Array.catMaybes(map(DataViz_Layout_Sankey_Types.initialiseSankeyNode(model))(model.nodeOrder));
    return modify_(function (v) {
        var $130 = {};
        for (var $131 in v) {
            if ({}.hasOwnProperty.call(v, $131)) {
                $130[$131] = v[$131];
            };
        };
        $130.sankeyNodes = sankeyNodes;
        return $130;
    });
});
var epsilon = 1.0e-6;
var relaxation = function (nodes) {
    return function (links) {
        return function (config) {
            return function (padding) {
                return function (y0) {
                    return function (y1) {
                        var updateNodes = function (allNodes) {
                            return function (updated) {
                                return map(function (node) {
                                    var v = Data_Array.find(function (u) {
                                        return eq1(u.node.index)(node.index);
                                    })(updated);
                                    if (v instanceof Data_Maybe.Just) {
                                        return v.value0.node;
                                    };
                                    if (v instanceof Data_Maybe.Nothing) {
                                        return node;
                                    };
                                    throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 835, column 11 - line 837, column 28): " + [ v.constructor.name ]);
                                })(allNodes);
                            };
                        };
                        var targetTop = function (source) {
                            return function (target) {
                                return function (_sortedSourceLinks) {
                                    return function (allNodes) {
                                        return function (allLinks) {
                                            return function (py) {
                                                var targetIncoming = Data_Array.sortBy(function (a) {
                                                    return function (b) {
                                                        var v = Data_Array.find(function (n) {
                                                            return eq1(n.index)(b.sourceIndex);
                                                        })(allNodes);
                                                        var v1 = Data_Array.find(function (n) {
                                                            return eq1(n.index)(a.sourceIndex);
                                                        })(allNodes);
                                                        if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                            return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                        };
                                                        return compare1(a.index)(b.index);
                                                    };
                                                })(Data_Array.filter(function (l) {
                                                    return eq1(l.targetIndex)(target.index);
                                                })(allLinks));
                                                var sourceOutgoing = Data_Array.sortBy(function (a) {
                                                    return function (b) {
                                                        var v = Data_Array.find(function (n) {
                                                            return eq1(n.index)(b.targetIndex);
                                                        })(allNodes);
                                                        var v1 = Data_Array.find(function (n) {
                                                            return eq1(n.index)(a.targetIndex);
                                                        })(allNodes);
                                                        if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                            return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                        };
                                                        return compare1(a.index)(b.index);
                                                    };
                                                })(Data_Array.filter(function (l) {
                                                    return eq1(l.sourceIndex)(source.index);
                                                })(allLinks));
                                                var numTargetLinks = Data_Int.toNumber(Data_Array.length(targetIncoming));
                                                var startY = target.y0 - ((numTargetLinks - 1.0) * py) / 2.0;
                                                var yAtTarget = Data_Array.foldl(function (acc) {
                                                    return function (link) {
                                                        if (acc.found) {
                                                            return acc;
                                                        };
                                                        var $144 = eq1(link.sourceIndex)(source.index);
                                                        if ($144) {
                                                            return {
                                                                y: acc.y,
                                                                found: true
                                                            };
                                                        };
                                                        return {
                                                            y: acc.y + link.width + py,
                                                            found: false
                                                        };
                                                    };
                                                })({
                                                    y: startY,
                                                    found: false
                                                })(targetIncoming);
                                                var yFinal = Data_Array.foldl(function (acc) {
                                                    return function (link) {
                                                        if (acc.found) {
                                                            return acc;
                                                        };
                                                        var $146 = eq1(link.targetIndex)(target.index);
                                                        if ($146) {
                                                            return {
                                                                y: acc.y,
                                                                found: true
                                                            };
                                                        };
                                                        return {
                                                            y: acc.y - link.width,
                                                            found: false
                                                        };
                                                    };
                                                })({
                                                    y: yAtTarget.y,
                                                    found: false
                                                })(sourceOutgoing);
                                                return yFinal.y;
                                            };
                                        };
                                    };
                                };
                            };
                        };
                        var sourceTop = function (source) {
                            return function (target) {
                                return function (_sortedTargetLinks) {
                                    return function (allNodes) {
                                        return function (allLinks) {
                                            return function (py) {
                                                var targetIncoming = Data_Array.sortBy(function (a) {
                                                    return function (b) {
                                                        var v = Data_Array.find(function (n) {
                                                            return eq1(n.index)(b.sourceIndex);
                                                        })(allNodes);
                                                        var v1 = Data_Array.find(function (n) {
                                                            return eq1(n.index)(a.sourceIndex);
                                                        })(allNodes);
                                                        if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                            return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                        };
                                                        return compare1(a.index)(b.index);
                                                    };
                                                })(Data_Array.filter(function (l) {
                                                    return eq1(l.targetIndex)(target.index);
                                                })(allLinks));
                                                var sourceOutgoing = Data_Array.sortBy(function (a) {
                                                    return function (b) {
                                                        var v = Data_Array.find(function (n) {
                                                            return eq1(n.index)(b.targetIndex);
                                                        })(allNodes);
                                                        var v1 = Data_Array.find(function (n) {
                                                            return eq1(n.index)(a.targetIndex);
                                                        })(allNodes);
                                                        if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                            return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                        };
                                                        return compare1(a.index)(b.index);
                                                    };
                                                })(Data_Array.filter(function (l) {
                                                    return eq1(l.sourceIndex)(source.index);
                                                })(allLinks));
                                                var numSourceLinks = Data_Int.toNumber(Data_Array.length(sourceOutgoing));
                                                var startY = source.y0 - ((numSourceLinks - 1.0) * py) / 2.0;
                                                var yAtSource = Data_Array.foldl(function (acc) {
                                                    return function (link) {
                                                        if (acc.found) {
                                                            return acc;
                                                        };
                                                        var $156 = eq1(link.targetIndex)(target.index);
                                                        if ($156) {
                                                            return {
                                                                y: acc.y,
                                                                found: true
                                                            };
                                                        };
                                                        return {
                                                            y: acc.y + link.width + py,
                                                            found: false
                                                        };
                                                    };
                                                })({
                                                    y: startY,
                                                    found: false
                                                })(sourceOutgoing);
                                                var yFinal = Data_Array.foldl(function (acc) {
                                                    return function (link) {
                                                        if (acc.found) {
                                                            return acc;
                                                        };
                                                        var $158 = eq1(link.sourceIndex)(source.index);
                                                        if ($158) {
                                                            return {
                                                                y: acc.y,
                                                                found: true
                                                            };
                                                        };
                                                        return {
                                                            y: acc.y - link.width,
                                                            found: false
                                                        };
                                                    };
                                                })({
                                                    y: yAtSource.y,
                                                    found: false
                                                })(targetIncoming);
                                                return yFinal.y;
                                            };
                                        };
                                    };
                                };
                            };
                        };
                        var resolveCollisionsTopToBottom = function (nodes1) {
                            return function (startIdx) {
                                return function (targetY) {
                                    return function (padding1) {
                                        return function (beta) {
                                            var n = Data_Array.length(nodes1);
                                            var go = function ($copy_idx) {
                                                return function ($copy_y) {
                                                    return function ($copy_currentNodes) {
                                                        var $tco_var_idx = $copy_idx;
                                                        var $tco_var_y = $copy_y;
                                                        var $tco_done = false;
                                                        var $tco_result;
                                                        function $tco_loop(idx, y, currentNodes) {
                                                            var $159 = idx >= n;
                                                            if ($159) {
                                                                $tco_done = true;
                                                                return currentNodes;
                                                            };
                                                            var v = Data_Array.index(currentNodes)(idx);
                                                            if (v instanceof Data_Maybe.Nothing) {
                                                                $tco_done = true;
                                                                return currentNodes;
                                                            };
                                                            if (v instanceof Data_Maybe.Just) {
                                                                var dy = (y - v.value0.node.y0) * beta;
                                                                var updated = (function () {
                                                                    var $161 = dy > epsilon;
                                                                    if ($161) {
                                                                        var newNode = {
                                                                            color: v.value0.node.color,
                                                                            depth: v.value0.node.depth,
                                                                            index: v.value0.node.index,
                                                                            layer: v.value0.node.layer,
                                                                            name: v.value0.node.name,
                                                                            nodeHeight: v.value0.node.nodeHeight,
                                                                            sourceLinks: v.value0.node.sourceLinks,
                                                                            targetLinks: v.value0.node.targetLinks,
                                                                            value: v.value0.node.value,
                                                                            x0: v.value0.node.x0,
                                                                            x1: v.value0.node.x1,
                                                                            y0: v.value0.node.y0 + dy,
                                                                            y1: v.value0.node.y1 + dy
                                                                        };
                                                                        return Data_Maybe.fromMaybe(currentNodes)(Data_Array.updateAt(idx)({
                                                                            node: newNode,
                                                                            targetY: v.value0.targetY
                                                                        })(currentNodes));
                                                                    };
                                                                    return currentNodes;
                                                                })();
                                                                var newY = (function () {
                                                                    var v1 = Data_Array.index(updated)(idx);
                                                                    if (v1 instanceof Data_Maybe.Just) {
                                                                        return v1.value0.node.y1 + padding1;
                                                                    };
                                                                    if (v1 instanceof Data_Maybe.Nothing) {
                                                                        return y;
                                                                    };
                                                                    throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 822, column 22 - line 824, column 29): " + [ v1.constructor.name ]);
                                                                })();
                                                                $tco_var_idx = idx + 1 | 0;
                                                                $tco_var_y = newY;
                                                                $copy_currentNodes = updated;
                                                                return;
                                                            };
                                                            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 809, column 14 - line 826, column 40): " + [ v.constructor.name ]);
                                                        };
                                                        while (!$tco_done) {
                                                            $tco_result = $tco_loop($tco_var_idx, $tco_var_y, $copy_currentNodes);
                                                        };
                                                        return $tco_result;
                                                    };
                                                };
                                            };
                                            return go(startIdx)(targetY)(nodes1);
                                        };
                                    };
                                };
                            };
                        };
                        var resolveCollisionsBottomToTop = function (nodes1) {
                            return function (startIdx) {
                                return function (targetY) {
                                    return function (padding1) {
                                        return function (beta) {
                                            var $165 = startIdx < 0;
                                            if ($165) {
                                                return nodes1;
                                            };
                                            var go = function ($copy_idx) {
                                                return function ($copy_y) {
                                                    return function ($copy_currentNodes) {
                                                        var $tco_var_idx = $copy_idx;
                                                        var $tco_var_y = $copy_y;
                                                        var $tco_done1 = false;
                                                        var $tco_result;
                                                        function $tco_loop(idx, y, currentNodes) {
                                                            var $166 = idx < 0;
                                                            if ($166) {
                                                                $tco_done1 = true;
                                                                return currentNodes;
                                                            };
                                                            var v = Data_Array.index(currentNodes)(idx);
                                                            if (v instanceof Data_Maybe.Nothing) {
                                                                $tco_done1 = true;
                                                                return currentNodes;
                                                            };
                                                            if (v instanceof Data_Maybe.Just) {
                                                                var dy = (v.value0.node.y1 - y) * beta;
                                                                var updated = (function () {
                                                                    var $168 = dy > epsilon;
                                                                    if ($168) {
                                                                        var newNode = {
                                                                            color: v.value0.node.color,
                                                                            depth: v.value0.node.depth,
                                                                            index: v.value0.node.index,
                                                                            layer: v.value0.node.layer,
                                                                            name: v.value0.node.name,
                                                                            nodeHeight: v.value0.node.nodeHeight,
                                                                            sourceLinks: v.value0.node.sourceLinks,
                                                                            targetLinks: v.value0.node.targetLinks,
                                                                            value: v.value0.node.value,
                                                                            x0: v.value0.node.x0,
                                                                            x1: v.value0.node.x1,
                                                                            y0: v.value0.node.y0 - dy,
                                                                            y1: v.value0.node.y1 - dy
                                                                        };
                                                                        return Data_Maybe.fromMaybe(currentNodes)(Data_Array.updateAt(idx)({
                                                                            node: newNode,
                                                                            targetY: v.value0.targetY
                                                                        })(currentNodes));
                                                                    };
                                                                    return currentNodes;
                                                                })();
                                                                var newY = (function () {
                                                                    var v1 = Data_Array.index(updated)(idx);
                                                                    if (v1 instanceof Data_Maybe.Just) {
                                                                        return v1.value0.node.y0 - padding1;
                                                                    };
                                                                    if (v1 instanceof Data_Maybe.Nothing) {
                                                                        return y;
                                                                    };
                                                                    throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 791, column 24 - line 793, column 31): " + [ v1.constructor.name ]);
                                                                })();
                                                                $tco_var_idx = idx - 1 | 0;
                                                                $tco_var_y = newY;
                                                                $copy_currentNodes = updated;
                                                                return;
                                                            };
                                                            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 778, column 16 - line 795, column 42): " + [ v.constructor.name ]);
                                                        };
                                                        while (!$tco_done1) {
                                                            $tco_result = $tco_loop($tco_var_idx, $tco_var_y, $copy_currentNodes);
                                                        };
                                                        return $tco_result;
                                                    };
                                                };
                                            };
                                            return go(startIdx)(targetY)(nodes1);
                                        };
                                    };
                                };
                            };
                        };
                        var resolveCollisions = function (sorted) {
                            return function (padding1) {
                                return function (yMin) {
                                    return function (yMax) {
                                        return function (beta) {
                                            var $172 = Data_Array["null"](sorted);
                                            if ($172) {
                                                return sorted;
                                            };
                                            var n = Data_Array.length(sorted);
                                            var middleIdx = div1(n)(2);
                                            var middleNode = Data_Array.index(sorted)(middleIdx);
                                            var startYDown = (function () {
                                                if (middleNode instanceof Data_Maybe.Just) {
                                                    return middleNode.value0.node.y1 + padding1;
                                                };
                                                if (middleNode instanceof Data_Maybe.Nothing) {
                                                    return yMin;
                                                };
                                                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 754, column 22 - line 756, column 26): " + [ middleNode.constructor.name ]);
                                            })();
                                            var startYUp = (function () {
                                                if (middleNode instanceof Data_Maybe.Just) {
                                                    return middleNode.value0.node.y0 - padding1;
                                                };
                                                if (middleNode instanceof Data_Maybe.Nothing) {
                                                    return yMax;
                                                };
                                                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 746, column 20 - line 748, column 26): " + [ middleNode.constructor.name ]);
                                            })();
                                            var pushedUp = resolveCollisionsBottomToTop(sorted)(middleIdx - 1 | 0)(startYUp)(padding1)(beta);
                                            var pushedUpAndDown = resolveCollisionsTopToBottom(pushedUp)(middleIdx + 1 | 0)(startYDown)(padding1)(beta);
                                            var clampedBottom = resolveCollisionsBottomToTop(pushedUpAndDown)(n - 1 | 0)(yMax)(padding1)(beta);
                                            var clampedTop = resolveCollisionsTopToBottom(clampedBottom)(0)(yMin)(padding1)(beta);
                                            return clampedTop;
                                        };
                                    };
                                };
                            };
                        };
                        var calculateWeightedFromTargets = function (node) {
                            return function (allNodes) {
                                return function (allLinks) {
                                    return function (padding1) {
                                        var outgoingLinks = Data_Array.filter(function (l) {
                                            return eq1(l.sourceIndex)(node.index);
                                        })(allLinks);
                                        var sortedLinks = Data_Array.sortBy(function (a) {
                                            return function (b) {
                                                var v = Data_Array.find(function (n) {
                                                    return eq1(n.index)(b.targetIndex);
                                                })(allNodes);
                                                var v1 = Data_Array.find(function (n) {
                                                    return eq1(n.index)(a.targetIndex);
                                                })(allNodes);
                                                if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                    return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                };
                                                return compare1(a.index)(b.index);
                                            };
                                        })(outgoingLinks);
                                        var result = Data_Array.foldl(function (acc) {
                                            return function (link) {
                                                var v = Data_Array.find(function (n) {
                                                    return eq1(n.index)(link.targetIndex);
                                                })(allNodes);
                                                if (v instanceof Data_Maybe.Just) {
                                                    var layerDist = Data_Int.toNumber(v.value0.layer - node.layer | 0);
                                                    var v1 = link.value * max1(1.0)(layerDist);
                                                    var idealY = targetTop(node)(v.value0)(sortedLinks)(allNodes)(allLinks)(padding1);
                                                    return {
                                                        sum: acc.sum + idealY * v1,
                                                        totalWeight: acc.totalWeight + v1
                                                    };
                                                };
                                                if (v instanceof Data_Maybe.Nothing) {
                                                    return acc;
                                                };
                                                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 572, column 13 - line 582, column 29): " + [ v.constructor.name ]);
                                            };
                                        })({
                                            sum: 0.0,
                                            totalWeight: 0.0
                                        })(sortedLinks);
                                        var $183 = result.totalWeight > 0.0;
                                        if ($183) {
                                            return result.sum / result.totalWeight;
                                        };
                                        return node.y0;
                                    };
                                };
                            };
                        };
                        var calculateWeightedFromSources = function (node) {
                            return function (allNodes) {
                                return function (allLinks) {
                                    return function (padding1) {
                                        var incomingLinks = Data_Array.filter(function (l) {
                                            return eq1(l.targetIndex)(node.index);
                                        })(allLinks);
                                        var sortedLinks = Data_Array.sortBy(function (a) {
                                            return function (b) {
                                                var v = Data_Array.find(function (n) {
                                                    return eq1(n.index)(b.sourceIndex);
                                                })(allNodes);
                                                var v1 = Data_Array.find(function (n) {
                                                    return eq1(n.index)(a.sourceIndex);
                                                })(allNodes);
                                                if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                    return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                };
                                                return compare1(a.index)(b.index);
                                            };
                                        })(incomingLinks);
                                        var result = Data_Array.foldl(function (acc) {
                                            return function (link) {
                                                var v = Data_Array.find(function (n) {
                                                    return eq1(n.index)(link.sourceIndex);
                                                })(allNodes);
                                                if (v instanceof Data_Maybe.Just) {
                                                    var layerDist = Data_Int.toNumber(node.layer - v.value0.layer | 0);
                                                    var v1 = link.value * max1(1.0)(layerDist);
                                                    var idealY = sourceTop(v.value0)(node)(sortedLinks)(allNodes)(allLinks)(padding1);
                                                    return {
                                                        sum: acc.sum + idealY * v1,
                                                        totalWeight: acc.totalWeight + v1
                                                    };
                                                };
                                                if (v instanceof Data_Maybe.Nothing) {
                                                    return acc;
                                                };
                                                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 610, column 13 - line 619, column 29): " + [ v.constructor.name ]);
                                            };
                                        })({
                                            sum: 0.0,
                                            totalWeight: 0.0
                                        })(sortedLinks);
                                        var $190 = result.totalWeight > 0.0;
                                        if ($190) {
                                            return result.sum / result.totalWeight;
                                        };
                                        return node.y0;
                                    };
                                };
                            };
                        };
                        var relaxLayer = function (currentNodes) {
                            return function (allLinks) {
                                return function (layerIdx) {
                                    return function (padding1) {
                                        return function (ascending) {
                                            return function (alpha) {
                                                return function (beta) {
                                                    var layerNodes = Data_Array.filter(function (n) {
                                                        return n.layer === layerIdx;
                                                    })(currentNodes);
                                                    var sortedLayerNodes = Data_Array.sortBy(function (a) {
                                                        return function (b) {
                                                            return compare(a.y0)(b.y0);
                                                        };
                                                    })(layerNodes);
                                                    var layerNodeIndices = map(function (v) {
                                                        return v.index;
                                                    })(sortedLayerNodes);
                                                    var nodesAfterRelax = Data_Array.foldl(function (nodes1) {
                                                        return function (nodeIdx) {
                                                            var v = Data_Array.find(function (n) {
                                                                return eq1(n.index)(nodeIdx);
                                                            })(nodes1);
                                                            if (v instanceof Data_Maybe.Nothing) {
                                                                return nodes1;
                                                            };
                                                            if (v instanceof Data_Maybe.Just) {
                                                                var weightedY = (function () {
                                                                    if (ascending) {
                                                                        return calculateWeightedFromSources(v.value0)(nodes1)(allLinks)(padding1);
                                                                    };
                                                                    return calculateWeightedFromTargets(v.value0)(nodes1)(allLinks)(padding1);
                                                                })();
                                                                var dy = (weightedY - v.value0.y0) * alpha;
                                                                var newY0 = v.value0.y0 + dy;
                                                                var newY1 = v.value0.y1 + dy;
                                                                var updatedNode = {
                                                                    color: v.value0.color,
                                                                    depth: v.value0.depth,
                                                                    index: v.value0.index,
                                                                    layer: v.value0.layer,
                                                                    name: v.value0.name,
                                                                    nodeHeight: v.value0.nodeHeight,
                                                                    sourceLinks: v.value0.sourceLinks,
                                                                    targetLinks: v.value0.targetLinks,
                                                                    value: v.value0.value,
                                                                    x0: v.value0.x0,
                                                                    x1: v.value0.x1,
                                                                    y0: newY0,
                                                                    y1: newY1
                                                                };
                                                                return map(function (n) {
                                                                    var $193 = eq1(n.index)(nodeIdx);
                                                                    if ($193) {
                                                                        return updatedNode;
                                                                    };
                                                                    return n;
                                                                })(nodes1);
                                                            };
                                                            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 515, column 13 - line 532, column 82): " + [ v.constructor.name ]);
                                                        };
                                                    })(currentNodes)(layerNodeIndices);
                                                    var layerNodesUpdated = Data_Array.filter(function (n) {
                                                        return n.layer === layerIdx;
                                                    })(nodesAfterRelax);
                                                    var sorted = Data_Array.sortBy(function (a) {
                                                        return function (b) {
                                                            return compare(a.y0)(b.y0);
                                                        };
                                                    })(layerNodesUpdated);
                                                    var sortedWithTarget = map(function (node) {
                                                        return {
                                                            node: node,
                                                            targetY: node.y0
                                                        };
                                                    })(sorted);
                                                    var resolved = resolveCollisions(sortedWithTarget)(padding1)(y0)(y1)(beta);
                                                    return updateNodes(nodesAfterRelax)(resolved);
                                                };
                                            };
                                        };
                                    };
                                };
                            };
                        };
                        var relaxByLayer = function (currentNodes) {
                            return function (allLinks) {
                                return function (padding1) {
                                    return function (ascending) {
                                        return function (alpha) {
                                            return function (beta) {
                                                var maxLayer = Data_Array.foldl(function (acc) {
                                                    return function (node) {
                                                        return max(acc)(node.layer);
                                                    };
                                                })(0)(currentNodes);
                                                var layerIndices = (function () {
                                                    if (ascending) {
                                                        return Data_Array.range(1)(maxLayer);
                                                    };
                                                    return Data_Array.reverse(Data_Array.range(0)(maxLayer - 1 | 0));
                                                })();
                                                var relaxed = Data_Array.foldl(function (nodes1) {
                                                    return function (layerIdx) {
                                                        return relaxLayer(nodes1)(allLinks)(layerIdx)(padding1)(ascending)(alpha)(beta);
                                                    };
                                                })(currentNodes)(layerIndices);
                                                return relaxed;
                                            };
                                        };
                                    };
                                };
                            };
                        };
                        var $196 = config.iterations <= 0;
                        if ($196) {
                            return nodes;
                        };
                        return Data_Array.foldl(function (currentNodes) {
                            return function (i) {
                                var alpha = Data_Number.pow(0.99)(Data_Int.toNumber(i));
                                var beta = max1(1.0 - alpha)(Data_Int.toNumber(i + 1 | 0) / Data_Int.toNumber(config.iterations));
                                var rtl = relaxByLayer(currentNodes)(links)(padding)(false)(alpha)(beta);
                                var ltr = relaxByLayer(rtl)(links)(padding)(true)(alpha)(beta);
                                return ltr;
                            };
                        })(nodes)(Data_Array.range(0)(config.iterations - 1 | 0));
                    };
                };
            };
        };
    };
};
var computeNodeValues = /* #__PURE__ */ (function () {
    var setNodeValue = function (links) {
        return function (n) {
            var totalOut = Data_Array.foldl(function (sum) {
                return function (link) {
                    return sum + link.value;
                };
            })(0.0)(Data_Array.filter(function (l) {
                return eq1(l.sourceIndex)(n.index);
            })(links));
            var totalIn = Data_Array.foldl(function (sum) {
                return function (link) {
                    return sum + link.value;
                };
            })(0.0)(Data_Array.filter(function (l) {
                return eq1(l.targetIndex)(n.index);
            })(links));
            return {
                name: n.name,
                x0: n.x0,
                y0: n.y0,
                x1: n.x1,
                y1: n.y1,
                depth: n.depth,
                nodeHeight: n.nodeHeight,
                layer: n.layer,
                index: n.index,
                color: n.color,
                sourceLinks: n.sourceLinks,
                targetLinks: n.targetLinks,
                value: max1(totalIn)(totalOut)
            };
        };
    };
    return bind(get)(function (model) {
        var updatedNodes = map(setNodeValue(model.sankeyLinks))(model.sankeyNodes);
        return modify_(function (v) {
            var $197 = {};
            for (var $198 in v) {
                if ({}.hasOwnProperty.call(v, $198)) {
                    $197[$198] = v[$198];
                };
            };
            $197.sankeyNodes = updatedNodes;
            return $197;
        });
    });
})();
var computeNodeHeights = /* #__PURE__ */ (function () {
    var bfsHeight = function ($copy_nodes) {
        return function ($copy_height) {
            return function ($copy_current) {
                return function ($copy_maxHeight) {
                    var $tco_var_nodes = $copy_nodes;
                    var $tco_var_height = $copy_height;
                    var $tco_var_current = $copy_current;
                    var $tco_done = false;
                    var $tco_result;
                    function $tco_loop(nodes, height, current, maxHeight) {
                        if (Data_Set.isEmpty(current)) {
                            $tco_done = true;
                            return nodes;
                        };
                        if (height > maxHeight) {
                            $tco_done = true;
                            return nodes;
                        };
                        if (Data_Boolean.otherwise) {
                            var nodesWithHeight = map(function (node) {
                                var $204 = member(node.index)(current);
                                if ($204) {
                                    return {
                                        index: node.index,
                                        color: node.color,
                                        depth: node.depth,
                                        layer: node.layer,
                                        name: node.name,
                                        sourceLinks: node.sourceLinks,
                                        targetLinks: node.targetLinks,
                                        value: node.value,
                                        x0: node.x0,
                                        x1: node.x1,
                                        y0: node.y0,
                                        y1: node.y1,
                                        nodeHeight: height
                                    };
                                };
                                return node;
                            })(nodes);
                            var next = Data_Array.foldl(function (acc) {
                                return function (node) {
                                    var $205 = member(node.index)(current);
                                    if ($205) {
                                        return union(acc)(node.targetLinks);
                                    };
                                    return acc;
                                };
                            })(Data_Set.empty)(nodes);
                            $tco_var_nodes = nodesWithHeight;
                            $tco_var_height = height + 1 | 0;
                            $tco_var_current = next;
                            $copy_maxHeight = maxHeight;
                            return;
                        };
                        throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 232, column 3 - line 232, column 84): " + [ nodes.constructor.name, height.constructor.name, current.constructor.name, maxHeight.constructor.name ]);
                    };
                    while (!$tco_done) {
                        $tco_result = $tco_loop($tco_var_nodes, $tco_var_height, $tco_var_current, $copy_maxHeight);
                    };
                    return $tco_result;
                };
            };
        };
    };
    return bind(get)(function (model) {
        var n = Data_Array.length(model.sankeyNodes);
        var sinkNodes = Data_Array.filter(function (node) {
            return Data_Set.isEmpty(node.sourceLinks);
        })(model.sankeyNodes);
        var initialCurrent = fromFoldable(map(function (v) {
            return v.index;
        })(sinkNodes));
        var result = bfsHeight(model.sankeyNodes)(0)(initialCurrent)(n);
        return modify_(function (v) {
            var $206 = {};
            for (var $207 in v) {
                if ({}.hasOwnProperty.call(v, $207)) {
                    $206[$207] = v[$207];
                };
            };
            $206.sankeyNodes = result;
            return $206;
        });
    });
})();
var computeNodeDepths = /* #__PURE__ */ (function () {
    var bfsDepth = function ($copy_nodes) {
        return function ($copy_depth) {
            return function ($copy_current) {
                return function ($copy_maxDepth) {
                    var $tco_var_nodes = $copy_nodes;
                    var $tco_var_depth = $copy_depth;
                    var $tco_var_current = $copy_current;
                    var $tco_done = false;
                    var $tco_result;
                    function $tco_loop(nodes, depth, current, maxDepth) {
                        if (Data_Set.isEmpty(current)) {
                            $tco_done = true;
                            return nodes;
                        };
                        if (depth > maxDepth) {
                            $tco_done = true;
                            return nodes;
                        };
                        if (Data_Boolean.otherwise) {
                            var nodesWithDepth = map(function (node) {
                                var $213 = member(node.index)(current);
                                if ($213) {
                                    return {
                                        index: node.index,
                                        color: node.color,
                                        layer: node.layer,
                                        name: node.name,
                                        nodeHeight: node.nodeHeight,
                                        sourceLinks: node.sourceLinks,
                                        targetLinks: node.targetLinks,
                                        value: node.value,
                                        x0: node.x0,
                                        x1: node.x1,
                                        y0: node.y0,
                                        y1: node.y1,
                                        depth: depth
                                    };
                                };
                                return node;
                            })(nodes);
                            var next = Data_Array.foldl(function (acc) {
                                return function (node) {
                                    var $214 = member(node.index)(current);
                                    if ($214) {
                                        return union(acc)(node.sourceLinks);
                                    };
                                    return acc;
                                };
                            })(Data_Set.empty)(nodes);
                            $tco_var_nodes = nodesWithDepth;
                            $tco_var_depth = depth + 1 | 0;
                            $tco_var_current = next;
                            $copy_maxDepth = maxDepth;
                            return;
                        };
                        throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 190, column 3 - line 190, column 83): " + [ nodes.constructor.name, depth.constructor.name, current.constructor.name, maxDepth.constructor.name ]);
                    };
                    while (!$tco_done) {
                        $tco_result = $tco_loop($tco_var_nodes, $tco_var_depth, $tco_var_current, $copy_maxDepth);
                    };
                    return $tco_result;
                };
            };
        };
    };
    return bind(get)(function (model) {
        var n = Data_Array.length(model.sankeyNodes);
        var sourceNodes = Data_Array.filter(function (node) {
            return Data_Set.isEmpty(node.targetLinks);
        })(model.sankeyNodes);
        var initialCurrent = fromFoldable(map(function (v) {
            return v.index;
        })(sourceNodes));
        var result = bfsDepth(model.sankeyNodes)(0)(initialCurrent)(n);
        return modify_(function (v) {
            var $215 = {};
            for (var $216 in v) {
                if ({}.hasOwnProperty.call(v, $216)) {
                    $215[$216] = v[$216];
                };
            };
            $215.sankeyNodes = result;
            return $215;
        });
    });
})();
var computeLinkBreadths = /* #__PURE__ */ (function () {
    var calculateLinkYPositions = function (nodes) {
        return function (links) {
            var linksWithY0 = Data_Array.foldl(function (currentLinks) {
                return function (node) {
                    var outgoingLinks = Data_Array.filter(function (link) {
                        return eq1(link.sourceIndex)(node.index);
                    })(currentLinks);
                    var sorted = Data_Array.sortBy(function (a) {
                        return function (b) {
                            var v = Data_Array.find(function (n) {
                                return eq1(n.index)(b.targetIndex);
                            })(nodes);
                            var v1 = Data_Array.find(function (n) {
                                return eq1(n.index)(a.targetIndex);
                            })(nodes);
                            if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                            };
                            return compare1(a.index)(b.index);
                        };
                    })(outgoingLinks);
                    var withY0 = Data_Array.foldl(function (acc) {
                        return function (link) {
                            var y = acc.y + link.width / 2.0;
                            var updated = {
                                width: link.width,
                                index: link.index,
                                sourceIndex: link.sourceIndex,
                                targetIndex: link.targetIndex,
                                color: link.color,
                                value: link.value,
                                y1: link.y1,
                                y0: y
                            };
                            return {
                                y: acc.y + link.width,
                                links: Data_Array.snoc(acc.links)(updated)
                            };
                        };
                    })({
                        y: node.y0,
                        links: [  ]
                    })(sorted);
                    return map(function (link) {
                        var v = Data_Array.find(function (l) {
                            return eq2(l.index)(link.index);
                        })(withY0.links);
                        if (v instanceof Data_Maybe.Just) {
                            return v.value0;
                        };
                        if (v instanceof Data_Maybe.Nothing) {
                            return link;
                        };
                        throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 920, column 21 - line 922, column 38): " + [ v.constructor.name ]);
                    })(currentLinks);
                };
            })(links)(nodes);
            var linksWithY1 = Data_Array.foldl(function (currentLinks) {
                return function (node) {
                    var incomingLinks = Data_Array.filter(function (link) {
                        return eq1(link.targetIndex)(node.index);
                    })(currentLinks);
                    var sorted = Data_Array.sortBy(function (a) {
                        return function (b) {
                            var v = Data_Array.find(function (n) {
                                return eq1(n.index)(b.sourceIndex);
                            })(nodes);
                            var v1 = Data_Array.find(function (n) {
                                return eq1(n.index)(a.sourceIndex);
                            })(nodes);
                            if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                            };
                            return compare1(a.index)(b.index);
                        };
                    })(incomingLinks);
                    var withY1 = Data_Array.foldl(function (acc) {
                        return function (link) {
                            var y = acc.y + link.width / 2.0;
                            var updated = {
                                width: link.width,
                                index: link.index,
                                sourceIndex: link.sourceIndex,
                                targetIndex: link.targetIndex,
                                color: link.color,
                                value: link.value,
                                y0: link.y0,
                                y1: y
                            };
                            return {
                                y: acc.y + link.width,
                                links: Data_Array.snoc(acc.links)(updated)
                            };
                        };
                    })({
                        y: node.y0,
                        links: [  ]
                    })(sorted);
                    return map(function (link) {
                        var v = Data_Array.find(function (l) {
                            return eq2(l.index)(link.index);
                        })(withY1.links);
                        if (v instanceof Data_Maybe.Just) {
                            return v.value0;
                        };
                        if (v instanceof Data_Maybe.Nothing) {
                            return link;
                        };
                        throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 961, column 21 - line 963, column 38): " + [ v.constructor.name ]);
                    })(currentLinks);
                };
            })(linksWithY0)(nodes);
            return linksWithY1;
        };
    };
    var calculateGlobalKy1 = function (nodes) {
        return function (y0) {
            return function (y1) {
                return function (padding) {
                    var scaleForLayer = function (layerNodes) {
                        var totalValue = Data_Array.foldl(function (sum) {
                            return function (node) {
                                return sum + node.value;
                            };
                        })(0.0)(layerNodes);
                        var numNodes = Data_Int.toNumber(Data_Array.length(layerNodes));
                        var availableHeight = y1 - y0 - (numNodes - 1.0) * padding;
                        var $230 = totalValue > 0.0;
                        if ($230) {
                            return availableHeight / totalValue;
                        };
                        return 1.0;
                    };
                    var maxLayer = Data_Array.foldl(function (acc) {
                        return function (node) {
                            return max(acc)(node.layer);
                        };
                    })(0)(nodes);
                    var layers = map(function (layerIdx) {
                        return Data_Array.filter(function (node) {
                            return node.layer === layerIdx;
                        })(nodes);
                    })(Data_Array.range(0)(maxLayer));
                    var scales = map(scaleForLayer)(layers);
                    var nonEmptyScales = Data_Array.filter(function (s) {
                        return s > 0.0;
                    })(scales);
                    var v = Data_Array.head(nonEmptyScales);
                    if (v instanceof Data_Maybe.Just) {
                        return Data_Array.foldl(min)(v.value0)(nonEmptyScales);
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return 1.0;
                    };
                    throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 880, column 7 - line 882, column 23): " + [ v.constructor.name ]);
                };
            };
        };
    };
    return bind(get)(function (model) {
        var ky = calculateGlobalKy1(model.sankeyNodes)(model.config.extent.y0)(model.config.extent.y1)(model.config.nodePadding);
        var linksWithWidth = map(function (link) {
            return {
                value: link.value,
                color: link.color,
                index: link.index,
                sourceIndex: link.sourceIndex,
                targetIndex: link.targetIndex,
                y0: link.y0,
                y1: link.y1,
                width: link.value * ky
            };
        })(model.sankeyLinks);
        var linksWithY = calculateLinkYPositions(model.sankeyNodes)(linksWithWidth);
        return modify_(function (v) {
            var $233 = {};
            for (var $234 in v) {
                if ({}.hasOwnProperty.call(v, $234)) {
                    $233[$234] = v[$234];
                };
            };
            $233.sankeyLinks = linksWithY;
            return $233;
        });
    });
})();
var calculateGlobalKy = function (nodes) {
    return function (y0) {
        return function (y1) {
            return function (padding) {
                var scaleForLayer = function (layerNodes) {
                    var totalValue = Data_Array.foldl(function (sum) {
                        return function (node) {
                            return sum + node.value;
                        };
                    })(0.0)(layerNodes);
                    var numNodes = Data_Int.toNumber(Data_Array.length(layerNodes));
                    var availableHeight = y1 - y0 - (numNodes - 1.0) * padding;
                    var $236 = totalValue > 0.0;
                    if ($236) {
                        return availableHeight / totalValue;
                    };
                    return 1.0;
                };
                var maxLayer = Data_Array.foldl(function (acc) {
                    return function (node) {
                        return max(acc)(node.layer);
                    };
                })(0)(nodes);
                var layers = map(function (layerIdx) {
                    return Data_Array.filter(function (node) {
                        return node.layer === layerIdx;
                    })(nodes);
                })(Data_Array.range(0)(maxLayer));
                var scales = map(scaleForLayer)(layers);
                var nonEmptyScales = Data_Array.filter(function (s) {
                    return s > 0.0;
                })(scales);
                var v = Data_Array.head(nonEmptyScales);
                if (v instanceof Data_Maybe.Just) {
                    return Data_Array.foldl(min)(v.value0)(nonEmptyScales);
                };
                if (v instanceof Data_Maybe.Nothing) {
                    return 1.0;
                };
                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 281, column 5 - line 283, column 21): " + [ v.constructor.name ]);
            };
        };
    };
};
var assignColors = /* #__PURE__ */ bind(get)(function (model) {
    var colors = [ "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf" ];
    var nodesWithColor = Data_Array.mapWithIndex(function (i) {
        return function (node) {
            return {
                depth: node.depth,
                index: node.index,
                layer: node.layer,
                name: node.name,
                nodeHeight: node.nodeHeight,
                sourceLinks: node.sourceLinks,
                targetLinks: node.targetLinks,
                value: node.value,
                x0: node.x0,
                x1: node.x1,
                y0: node.y0,
                y1: node.y1,
                color: Data_Maybe.fromMaybe("#999")(Data_Array.index(colors)(mod(i)(Data_Array.length(colors))))
            };
        };
    })(model.sankeyNodes);
    var assignLinkColor = function (nodes) {
        return function (mode) {
            return function (link) {
                if (mode instanceof DataViz_Layout_Sankey_Types.SourceColor) {
                    var sourceNode = Data_Array.find(function (n) {
                        return eq1(n.index)(link.sourceIndex);
                    })(nodes);
                    return {
                        sourceIndex: link.sourceIndex,
                        targetIndex: link.targetIndex,
                        value: link.value,
                        width: link.width,
                        y0: link.y0,
                        y1: link.y1,
                        index: link.index,
                        color: Data_Maybe.maybe("#999")(function (n) {
                            return n.color;
                        })(sourceNode)
                    };
                };
                if (mode instanceof DataViz_Layout_Sankey_Types.TargetColor) {
                    var targetNode = Data_Array.find(function (n) {
                        return eq1(n.index)(link.targetIndex);
                    })(nodes);
                    return {
                        sourceIndex: link.sourceIndex,
                        targetIndex: link.targetIndex,
                        value: link.value,
                        width: link.width,
                        y0: link.y0,
                        y1: link.y1,
                        index: link.index,
                        color: Data_Maybe.maybe("#999")(function (n) {
                            return n.color;
                        })(targetNode)
                    };
                };
                if (mode instanceof DataViz_Layout_Sankey_Types.SourceTargetGradient) {
                    return {
                        sourceIndex: link.sourceIndex,
                        targetIndex: link.targetIndex,
                        value: link.value,
                        width: link.width,
                        y0: link.y0,
                        y1: link.y1,
                        index: link.index,
                        color: "url(#sankey-gradient-" + (show(link.index) + ")")
                    };
                };
                if (mode instanceof DataViz_Layout_Sankey_Types.StaticColor) {
                    return {
                        sourceIndex: link.sourceIndex,
                        targetIndex: link.targetIndex,
                        value: link.value,
                        width: link.width,
                        y0: link.y0,
                        y1: link.y1,
                        index: link.index,
                        color: mode.value0
                    };
                };
                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 1006, column 7 - line 1021, column 29): " + [ mode.constructor.name ]);
            };
        };
    };
    var linksWithColor = map(assignLinkColor(nodesWithColor)(model.config.linkColorMode))(model.sankeyLinks);
    return modify_(function (v) {
        var $242 = {};
        for (var $243 in v) {
            if ({}.hasOwnProperty.call(v, $243)) {
                $242[$243] = v[$243];
            };
        };
        $242.sankeyNodes = nodesWithColor;
        $242.sankeyLinks = linksWithColor;
        return $242;
    });
});
var alignNodeToLayer = function (alignment) {
    return function (node) {
        return function (numLayers) {
            if (alignment instanceof DataViz_Layout_Sankey_Types.Left) {
                return node.depth;
            };
            if (alignment instanceof DataViz_Layout_Sankey_Types.Right) {
                return max(0)((numLayers - 1 | 0) - node.nodeHeight | 0);
            };
            if (alignment instanceof DataViz_Layout_Sankey_Types.Justify) {
                var $246 = Data_Set.isEmpty(node.sourceLinks);
                if ($246) {
                    return numLayers - 1 | 0;
                };
                return node.depth;
            };
            if (alignment instanceof DataViz_Layout_Sankey_Types.Center) {
                var $247 = !Data_Set.isEmpty(node.targetLinks);
                if ($247) {
                    return node.depth;
                };
                return 0;
            };
            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 357, column 3 - line 367, column 13): " + [ alignment.constructor.name ]);
        };
    };
};
var computeNodeLayers = function (nodes) {
    return function (config) {
        return function (x0) {
            return function (x1) {
                var maxDepth = Data_Array.foldl(function (acc) {
                    return function (node) {
                        return max(acc)(node.depth);
                    };
                })(0)(nodes);
                var numLayers = maxDepth + 1 | 0;
                var nodesWithLayer = map(function (node) {
                    var layer = alignNodeToLayer(config.alignment)(node)(numLayers);
                    return {
                        color: node.color,
                        depth: node.depth,
                        index: node.index,
                        name: node.name,
                        nodeHeight: node.nodeHeight,
                        sourceLinks: node.sourceLinks,
                        targetLinks: node.targetLinks,
                        value: node.value,
                        x0: node.x0,
                        x1: node.x1,
                        y0: node.y0,
                        y1: node.y1,
                        layer: layer
                    };
                })(nodes);
                var kx = (x1 - x0 - config.nodeWidth) / max1(1.0)(Data_Int.toNumber(numLayers - 1 | 0));
                var nodesWithX = map(function (node) {
                    var x0Pos = x0 + Data_Int.toNumber(node.layer) * kx;
                    return {
                        layer: node.layer,
                        color: node.color,
                        depth: node.depth,
                        index: node.index,
                        name: node.name,
                        nodeHeight: node.nodeHeight,
                        sourceLinks: node.sourceLinks,
                        targetLinks: node.targetLinks,
                        value: node.value,
                        y0: node.y0,
                        y1: node.y1,
                        x0: x0Pos,
                        x1: x0Pos + config.nodeWidth
                    };
                })(nodesWithLayer);
                return nodesWithX;
            };
        };
    };
};
var computeNodeBreadths = /* #__PURE__ */ bind(get)(function (model) {
    var nodesWithLayers = computeNodeLayers(model.sankeyNodes)(model.config)(model.config.extent.x0)(model.config.extent.x1);
    var totalHeight = model.config.extent.y1 - model.config.extent.y0;
    var maxLayer = Data_Array.foldl(function (acc) {
        return function (node) {
            return max(acc)(node.layer);
        };
    })(0)(nodesWithLayers);
    var layers = map(function (layerIdx) {
        return Data_Array.filter(function (node) {
            return node.layer === layerIdx;
        })(nodesWithLayers);
    })(Data_Array.range(0)(maxLayer));
    var maxNodesInLayer = Data_Array.foldl(function (acc) {
        return function (layer) {
            return max(acc)(Data_Array.length(layer));
        };
    })(0)(layers);
    var adjustedPadding = (function () {
        var $248 = maxNodesInLayer > 1;
        if ($248) {
            return min(model.config.nodePadding)(totalHeight / (Data_Int.toNumber(maxNodesInLayer) - 1.0));
        };
        return model.config.nodePadding;
    })();
    var nodesWithY = initializeNodeBreadths(nodesWithLayers)(model.sankeyLinks)(model.config)(adjustedPadding)(model.config.extent.y0)(model.config.extent.y1);
    var ky = calculateGlobalKy(nodesWithY)(model.config.extent.y0)(model.config.extent.y1)(adjustedPadding);
    var linksWithWidth = map(function (link) {
        return {
            value: link.value,
            color: link.color,
            index: link.index,
            sourceIndex: link.sourceIndex,
            targetIndex: link.targetIndex,
            y0: link.y0,
            y1: link.y1,
            width: link.value * ky
        };
    })(model.sankeyLinks);
    var relaxedNodes = relaxation(nodesWithY)(linksWithWidth)(model.config)(adjustedPadding)(model.config.extent.y0)(model.config.extent.y1);
    return modify_(function (v) {
        var $249 = {};
        for (var $250 in v) {
            if ({}.hasOwnProperty.call(v, $250)) {
                $249[$250] = v[$250];
            };
        };
        $249.sankeyNodes = relaxedNodes;
        $249.sankeyLinks = linksWithWidth;
        return $249;
    });
});
var computeLayoutWithConfig = function (linkInputs) {
    return function (config) {
        var computeSankeyLayout = discard(for_(linkInputs)(processCSVLink))(function () {
            return discard(initialiseSankeyNodes)(function () {
                return discard(computeNodeValues)(function () {
                    return discard(computeNodeDepths)(function () {
                        return discard(computeNodeHeights)(function () {
                            return discard(computeNodeBreadths)(function () {
                                return discard(computeLinkBreadths)(function () {
                                    return assignColors;
                                });
                            });
                        });
                    });
                });
            });
        });
        var finalModel = Control_Monad_State.execState(computeSankeyLayout)(DataViz_Layout_Sankey_Types.initialSankeyGraphModel(config));
        return {
            nodes: finalModel.sankeyNodes,
            links: finalModel.sankeyLinks
        };
    };
};
var computeLayout = function (linkInputs) {
    return function (width) {
        return function (height) {
            return computeLayoutWithConfig(linkInputs)(DataViz_Layout_Sankey_Types.defaultSankeyConfig(width)(height));
        };
    };
};
export {
    epsilon,
    computeLayout,
    computeLayoutWithConfig
};
//# sourceMappingURL=index.js.map
