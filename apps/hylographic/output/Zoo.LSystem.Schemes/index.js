// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Function from "../Data.Function/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Monoid from "../Data.Monoid/index.js";
import * as Data_Number from "../Data.Number/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_String_CodeUnits from "../Data.String.CodeUnits/index.js";
import * as Zoo_LSystem_Types from "../Zoo.LSystem.Types/index.js";
var fold = /* #__PURE__ */ Data_Array.fold(Data_Monoid.monoidString);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordChar);
var max = /* #__PURE__ */ Data_Ord.max(Data_Ord.ordInt);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var Forward = /* #__PURE__ */ (function () {
    function Forward() {

    };
    Forward.value = new Forward();
    return Forward;
})();
var TurnLeft = /* #__PURE__ */ (function () {
    function TurnLeft() {

    };
    TurnLeft.value = new TurnLeft();
    return TurnLeft;
})();
var TurnRight = /* #__PURE__ */ (function () {
    function TurnRight() {

    };
    TurnRight.value = new TurnRight();
    return TurnRight;
})();
var Push = /* #__PURE__ */ (function () {
    function Push() {

    };
    Push.value = new Push();
    return Push;
})();
var Pop = /* #__PURE__ */ (function () {
    function Pop() {

    };
    Pop.value = new Pop();
    return Pop;
})();
var NoOp = /* #__PURE__ */ (function () {
    function NoOp() {

    };
    NoOp.value = new NoOp();
    return NoOp;
})();
var Stop = /* #__PURE__ */ (function () {
    function Stop(value0) {
        this.value0 = value0;
    };
    Stop.create = function (value0) {
        return new Stop(value0);
    };
    return Stop;
})();
var Continue = /* #__PURE__ */ (function () {
    function Continue(value0) {
        this.value0 = value0;
    };
    Continue.create = function (value0) {
        return new Continue(value0);
    };
    return Continue;
})();
var parseCmd = function (v) {
    if (v === "F") {
        return Forward.value;
    };
    if (v === "G") {
        return Forward.value;
    };
    if (v === "A") {
        return Forward.value;
    };
    if (v === "B") {
        return Forward.value;
    };
    if (v === "0") {
        return Forward.value;
    };
    if (v === "1") {
        return Forward.value;
    };
    if (v === "+") {
        return TurnLeft.value;
    };
    if (v === "-") {
        return TurnRight.value;
    };
    if (v === "[") {
        return Push.value;
    };
    if (v === "]") {
        return Pop.value;
    };
    return NoOp.value;
};
var initialState = {
    turtle: Zoo_LSystem_Types.initialTurtle,
    stack: [  ],
    segments: [  ],
    depth: 0
};
var initialExpansion = function (sys) {
    return {
        currentString: sys.axiom,
        iteration: 0,
        segments: [  ],
        bounds: Zoo_LSystem_Types.emptyBounds,
        continuation: Data_Maybe.Nothing.value
    };
};
var expandOnce = function (sys) {
    return function (str) {
        return fold(map(function (c) {
            return Data_Maybe.fromMaybe(Data_String_CodeUnits.singleton(c))(lookup(c)(sys.rules));
        })(Data_String_CodeUnits.toCharArray(str)));
    };
};
var expand = function (n) {
    return function (sys) {
        var iterate = function ($copy_v) {
            return function ($copy_v1) {
                return function ($copy_v2) {
                    var $tco_var_v = $copy_v;
                    var $tco_var_v1 = $copy_v1;
                    var $tco_done = false;
                    var $tco_result;
                    function $tco_loop(v, v1, v2) {
                        if (v === 0) {
                            $tco_done = true;
                            return v2;
                        };
                        $tco_var_v = v - 1 | 0;
                        $tco_var_v1 = v1;
                        $copy_v2 = v1(v2);
                        return;
                    };
                    while (!$tco_done) {
                        $tco_result = $tco_loop($tco_var_v, $tco_var_v1, $copy_v2);
                    };
                    return $tco_result;
                };
            };
        };
        return iterate(n)(expandOnce(sys))(sys.axiom);
    };
};
var executeCmd = function (angle) {
    return function (stepLength) {
        return function (cmd) {
            return function (state) {
                if (cmd instanceof Forward) {
                    var newY = state.turtle.y + stepLength * Data_Number.sin(state.turtle.angle);
                    var newX = state.turtle.x + stepLength * Data_Number.cos(state.turtle.angle);
                    var segment = {
                        x1: state.turtle.x,
                        y1: state.turtle.y,
                        x2: newX,
                        y2: newY,
                        depth: state.depth
                    };
                    var newTurtle = {
                        angle: state.turtle.angle,
                        penDown: state.turtle.penDown,
                        x: newX,
                        y: newY
                    };
                    var newSegments = (function () {
                        if (state.turtle.penDown) {
                            return Data_Array.snoc(state.segments)(segment);
                        };
                        return state.segments;
                    })();
                    return {
                        stack: state.stack,
                        depth: state.depth,
                        turtle: newTurtle,
                        segments: newSegments
                    };
                };
                if (cmd instanceof TurnLeft) {
                    return {
                        stack: state.stack,
                        segments: state.segments,
                        depth: state.depth,
                        turtle: {
                            x: state.turtle.x,
                            y: state.turtle.y,
                            penDown: state.turtle.penDown,
                            angle: state.turtle.angle - Zoo_LSystem_Types.toRadians(angle)
                        }
                    };
                };
                if (cmd instanceof TurnRight) {
                    return {
                        stack: state.stack,
                        segments: state.segments,
                        depth: state.depth,
                        turtle: {
                            x: state.turtle.x,
                            y: state.turtle.y,
                            penDown: state.turtle.penDown,
                            angle: state.turtle.angle + Zoo_LSystem_Types.toRadians(angle)
                        }
                    };
                };
                if (cmd instanceof Push) {
                    return {
                        turtle: state.turtle,
                        segments: state.segments,
                        stack: Data_Array.cons(state.turtle)(state.stack),
                        depth: state.depth + 1 | 0
                    };
                };
                if (cmd instanceof Pop) {
                    var v = Data_Array.uncons(state.stack);
                    if (v instanceof Data_Maybe.Nothing) {
                        return state;
                    };
                    if (v instanceof Data_Maybe.Just) {
                        return {
                            segments: state.segments,
                            turtle: v.value0.head,
                            stack: v.value0.tail,
                            depth: max(0)(state.depth - 1 | 0)
                        };
                    };
                    throw new Error("Failed pattern match at Zoo.LSystem.Schemes (line 156, column 5 - line 162, column 16): " + [ v.constructor.name ]);
                };
                if (cmd instanceof NoOp) {
                    return state;
                };
                throw new Error("Failed pattern match at Zoo.LSystem.Schemes (line 121, column 41 - line 164, column 16): " + [ cmd.constructor.name ]);
            };
        };
    };
};
var interpret = function (angle) {
    return function (stepLength) {
        return function (str) {
            var chars = Data_String_CodeUnits.toCharArray(str);
            var cmds = map(parseCmd)(chars);
            var finalState = foldl(Data_Function.flip(executeCmd(angle)(stepLength)))(initialState)(cmds);
            return finalState.segments;
        };
    };
};
var expandLazy = function (sys) {
    return function (config) {
        return function (viewport) {
            var go = function ($copy_state) {
                var $tco_done = false;
                var $tco_result;
                function $tco_loop(state) {
                    if (Zoo_LSystem_Types.viewportFilled(viewport)(state.bounds)) {
                        $tco_done = true;
                        return state.segments;
                    };
                    if (state.iteration > 10) {
                        $tco_done = true;
                        return state.segments;
                    };
                    if (Data_Boolean.otherwise) {
                        var scaledStep = config.stepLength * Data_Number.pow(config.lengthScale)(Data_Int.toNumber(state.iteration));
                        var newString = expandOnce(sys)(state.currentString);
                        var newSegments = interpret(sys.angle)(scaledStep)(newString);
                        var newBounds = foldl(Zoo_LSystem_Types.expandBounds)(state.bounds)(newSegments);
                        var newState = {
                            currentString: newString,
                            iteration: state.iteration + 1 | 0,
                            segments: newSegments,
                            bounds: newBounds,
                            continuation: Data_Maybe.Nothing.value
                        };
                        $copy_state = newState;
                        return;
                    };
                    throw new Error("Failed pattern match at Zoo.LSystem.Schemes (line 218, column 3 - line 218, column 40): " + [ state.constructor.name ]);
                };
                while (!$tco_done) {
                    $tco_result = $tco_loop($copy_state);
                };
                return $tco_result;
            };
            return go;
        };
    };
};
var renderLazy = function (sys) {
    return function (config) {
        return function (viewport) {
            return expandLazy(sys)(config)(viewport)(initialExpansion(sys));
        };
    };
};
var render = function (iterations) {
    return function (sys) {
        return function (config) {
            var scaledStep = config.stepLength * Data_Number.pow(config.lengthScale)(Data_Int.toNumber(iterations));
            var expanded = expand(iterations)(sys);
            return interpret(sys.angle)(scaledStep)(expanded);
        };
    };
};
var applyDrift = function (psys) {
    return function (scrollY) {
        return {
            name: psys.base.name,
            axiom: psys.base.axiom,
            rules: psys.base.rules,
            description: psys.base.description,
            angle: psys.base.angle + psys.angleDrift(scrollY)
        };
    };
};
var renderWithDrift = function (psys) {
    return function (iterations) {
        return function (config) {
            return function (scrollY) {
                var driftedSys = applyDrift(psys)(scrollY);
                return render(iterations)(driftedSys)(config);
            };
        };
    };
};
export {
    expandOnce,
    expand,
    Forward,
    TurnLeft,
    TurnRight,
    Push,
    Pop,
    NoOp,
    parseCmd,
    initialState,
    executeCmd,
    interpret,
    render,
    Stop,
    Continue,
    expandLazy,
    initialExpansion,
    renderLazy,
    applyDrift,
    renderWithDrift
};
//# sourceMappingURL=index.js.map
