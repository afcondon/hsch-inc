// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Hylograph_ForceEngine_Setup from "../Hylograph.ForceEngine.Setup/index.js";
import * as Hylograph_ForceEngine_Setup_WASM from "../Hylograph.ForceEngine.Setup.WASM/index.js";
import * as Hylograph_ForceEngine_Simulation from "../Hylograph.ForceEngine.Simulation/index.js";
import * as Hylograph_Simulation_Emitter from "../Hylograph.Simulation.Emitter/index.js";
import * as Hylograph_Transition_Coordinator from "../Hylograph.Transition.Coordinator/index.js";
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var unless = /* #__PURE__ */ Control_Applicative.unless(Effect.applicativeEffect);
var when = /* #__PURE__ */ Control_Applicative.when(Effect.applicativeEffect);
var D3 = /* #__PURE__ */ (function () {
    function D3() {

    };
    D3.value = new D3();
    return D3;
})();
var WASM = /* #__PURE__ */ (function () {
    function WASM() {

    };
    WASM.value = new WASM();
    return WASM;
})();
var wasmConsumer = function (sim) {
    return function (emitterHandle) {
        return function (alphaRef) {
            return function (alphaMin) {
                return function (_deltaMs) {
                    return function __do() {
                        var alpha = Hylograph_ForceEngine_Setup_WASM.tick(sim)();
                        Effect_Ref.write(alpha)(alphaRef)();
                        var nodes = Hylograph_ForceEngine_Setup_WASM.getNodes(sim)();
                        Hylograph_Simulation_Emitter.emit(emitterHandle)(new Hylograph_Simulation_Emitter.Tick({
                            alpha: alpha,
                            nodeCount: Data_Array.length(nodes)
                        }))();
                        var $13 = alpha < alphaMin;
                        if ($13) {
                            return Hylograph_Transition_Coordinator.Completed.value;
                        };
                        return new Hylograph_Transition_Coordinator.Converged(alpha);
                    };
                };
            };
        };
    };
};
var runWASMSimulation = function (config) {
    return function __do() {
        var v = Hylograph_Simulation_Emitter.create();
        var sim = Hylograph_ForceEngine_Setup_WASM.create(config.nodes)(config.links)();
        Hylograph_ForceEngine_Setup_WASM.applySetupWithData(config.setup)(config.nodes)(config.links)(sim)();
        var setupRef = Effect_Ref["new"](config.setup)();
        var alphaRef = Effect_Ref["new"](1.0)();
        var coord = Hylograph_Transition_Coordinator.create();
        var coordRef = Effect_Ref["new"](coord)();
        var runningRef = Effect_Ref["new"](true)();
        Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Started.value)();
        Hylograph_Transition_Coordinator.register(coord)({
            tick: wasmConsumer(sim)(v.handle)(alphaRef)(config.alphaMin),
            onComplete: function __do() {
                Effect_Ref.write(false)(runningRef)();
                return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Completed.value)();
            }
        })();
        Hylograph_Transition_Coordinator.start(coord)();
        return {
            events: v.emitter,
            handle: {
                updateData: function (nodes) {
                    return function (links) {
                        return function __do() {
                            var currentSetup = Effect_Ref.read(setupRef)();
                            var result = Hylograph_ForceEngine_Setup_WASM.applySetupWithData(currentSetup)(nodes)(links)(sim)();
                            Hylograph_ForceEngine_Setup_WASM.reheat(sim)();
                            Effect_Ref.write(1.0)(alphaRef)();
                            Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Started.value)();
                            var running = Effect_Ref.read(runningRef)();
                            unless(running)(function __do() {
                                Effect_Ref.write(true)(runningRef)();
                                var oldCoord = Effect_Ref.read(coordRef)();
                                Hylograph_Transition_Coordinator.stop(oldCoord)();
                                var c = Hylograph_Transition_Coordinator.create();
                                Effect_Ref.write(c)(coordRef)();
                                Hylograph_Transition_Coordinator.register(c)({
                                    tick: wasmConsumer(sim)(v.handle)(alphaRef)(config.alphaMin),
                                    onComplete: function __do() {
                                        Effect_Ref.write(false)(runningRef)();
                                        return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Completed.value)();
                                    }
                                })();
                                return Hylograph_Transition_Coordinator.start(c)();
                            })();
                            return result;
                        };
                    };
                },
                updateSetup: function (newSetup) {
                    return function __do() {
                        Effect_Ref.write(newSetup)(setupRef)();
                        Hylograph_ForceEngine_Setup_WASM.applySetup(newSetup)(sim)();
                        Hylograph_ForceEngine_Setup_WASM.reheat(sim)();
                        Effect_Ref.write(1.0)(alphaRef)();
                        Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Started.value)();
                        var running = Effect_Ref.read(runningRef)();
                        return unless(running)(function __do() {
                            Effect_Ref.write(true)(runningRef)();
                            var oldCoord = Effect_Ref.read(coordRef)();
                            Hylograph_Transition_Coordinator.stop(oldCoord)();
                            var c = Hylograph_Transition_Coordinator.create();
                            Effect_Ref.write(c)(coordRef)();
                            Hylograph_Transition_Coordinator.register(c)({
                                tick: wasmConsumer(sim)(v.handle)(alphaRef)(config.alphaMin),
                                onComplete: function __do() {
                                    Effect_Ref.write(false)(runningRef)();
                                    return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Completed.value)();
                                }
                            })();
                            return Hylograph_Transition_Coordinator.start(c)();
                        })();
                    };
                },
                getNodes: Hylograph_ForceEngine_Setup_WASM.getNodes(sim),
                getAlpha: Effect_Ref.read(alphaRef),
                stop: function __do() {
                    var running = Effect_Ref.read(runningRef)();
                    return when(running)(function __do() {
                        Effect_Ref.write(false)(runningRef)();
                        return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Stopped.value)();
                    })();
                },
                start: function __do() {
                    var running = Effect_Ref.read(runningRef)();
                    return unless(running)(function __do() {
                        Hylograph_ForceEngine_Setup_WASM.reheat(sim)();
                        Effect_Ref.write(1.0)(alphaRef)();
                        Effect_Ref.write(true)(runningRef)();
                        Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Started.value)();
                        var oldCoord = Effect_Ref.read(coordRef)();
                        Hylograph_Transition_Coordinator.stop(oldCoord)();
                        var c = Hylograph_Transition_Coordinator.create();
                        Effect_Ref.write(c)(coordRef)();
                        Hylograph_Transition_Coordinator.register(c)({
                            tick: wasmConsumer(sim)(v.handle)(alphaRef)(config.alphaMin),
                            onComplete: function __do() {
                                Effect_Ref.write(false)(runningRef)();
                                return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Completed.value)();
                            }
                        })();
                        return Hylograph_Transition_Coordinator.start(c)();
                    })();
                },
                reheat: function __do() {
                    Hylograph_ForceEngine_Setup_WASM.reheat(sim)();
                    Effect_Ref.write(1.0)(alphaRef)();
                    return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Started.value)();
                },
                interpolatePositions: function (v1) {
                    return function (v2) {
                        return function (v3) {
                            return pure(Data_Unit.unit);
                        };
                    };
                },
                pinNodes: pure(Data_Unit.unit),
                unpinNodes: pure(Data_Unit.unit)
            }
        };
    };
};
var initWASM = Hylograph_ForceEngine_Setup_WASM.initWasm;
var d3Consumer = function (sim) {
    return function (emitterHandle) {
        return function (alphaRef) {
            return function (alphaMin) {
                return function (_deltaMs) {
                    return function __do() {
                        var alpha = Hylograph_ForceEngine_Simulation.tick(sim)();
                        Effect_Ref.write(alpha)(alphaRef)();
                        var nodes = Hylograph_ForceEngine_Simulation.getNodes(sim)();
                        Hylograph_Simulation_Emitter.emit(emitterHandle)(new Hylograph_Simulation_Emitter.Tick({
                            alpha: alpha,
                            nodeCount: Data_Array.length(nodes)
                        }))();
                        var $17 = alpha < alphaMin;
                        if ($17) {
                            return Hylograph_Transition_Coordinator.Completed.value;
                        };
                        return new Hylograph_Transition_Coordinator.Converged(alpha);
                    };
                };
            };
        };
    };
};
var runD3Simulation = function (config) {
    return function __do() {
        var v = Hylograph_Simulation_Emitter.create();
        var simConfig = {
            alphaTarget: Hylograph_ForceEngine_Simulation.defaultConfig.alphaTarget,
            velocityDecay: Hylograph_ForceEngine_Simulation.defaultConfig.velocityDecay,
            alphaDecay: config.setup.params.alphaDecay,
            alphaMin: config.alphaMin
        };
        var sim = Hylograph_ForceEngine_Simulation.create(simConfig)();
        Hylograph_ForceEngine_Setup.applySetupWithData(config.setup)(config.nodes)(config.links)(sim)();
        var setupRef = Effect_Ref["new"](config.setup)();
        var alphaRef = Effect_Ref["new"](1.0)();
        var coord = Hylograph_Transition_Coordinator.create();
        var coordRef = Effect_Ref["new"](coord)();
        var runningRef = Effect_Ref["new"](true)();
        Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Started.value)();
        Hylograph_Transition_Coordinator.register(coord)({
            tick: d3Consumer(sim)(v.handle)(alphaRef)(config.alphaMin),
            onComplete: function __do() {
                Effect_Ref.write(false)(runningRef)();
                return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Completed.value)();
            }
        })();
        Hylograph_Transition_Coordinator.start(coord)();
        return {
            events: v.emitter,
            handle: {
                updateData: function (nodes) {
                    return function (links) {
                        return function __do() {
                            var currentSetup = Effect_Ref.read(setupRef)();
                            var result = Hylograph_ForceEngine_Setup.applySetupWithData(currentSetup)(nodes)(links)(sim)();
                            Hylograph_ForceEngine_Simulation.reheat(sim)();
                            Effect_Ref.write(1.0)(alphaRef)();
                            Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Started.value)();
                            var running = Effect_Ref.read(runningRef)();
                            unless(running)(function __do() {
                                Effect_Ref.write(true)(runningRef)();
                                var oldCoord = Effect_Ref.read(coordRef)();
                                Hylograph_Transition_Coordinator.stop(oldCoord)();
                                var c = Hylograph_Transition_Coordinator.create();
                                Effect_Ref.write(c)(coordRef)();
                                Hylograph_Transition_Coordinator.register(c)({
                                    tick: d3Consumer(sim)(v.handle)(alphaRef)(config.alphaMin),
                                    onComplete: function __do() {
                                        Effect_Ref.write(false)(runningRef)();
                                        return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Completed.value)();
                                    }
                                })();
                                return Hylograph_Transition_Coordinator.start(c)();
                            })();
                            return result;
                        };
                    };
                },
                updateSetup: function (newSetup) {
                    return function __do() {
                        Effect_Ref.write(newSetup)(setupRef)();
                        Hylograph_ForceEngine_Setup.applySetup(newSetup)(sim)();
                        Hylograph_ForceEngine_Simulation.reheat(sim)();
                        Effect_Ref.write(1.0)(alphaRef)();
                        Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Started.value)();
                        var running = Effect_Ref.read(runningRef)();
                        return unless(running)(function __do() {
                            Effect_Ref.write(true)(runningRef)();
                            var oldCoord = Effect_Ref.read(coordRef)();
                            Hylograph_Transition_Coordinator.stop(oldCoord)();
                            var c = Hylograph_Transition_Coordinator.create();
                            Effect_Ref.write(c)(coordRef)();
                            Hylograph_Transition_Coordinator.register(c)({
                                tick: d3Consumer(sim)(v.handle)(alphaRef)(config.alphaMin),
                                onComplete: function __do() {
                                    Effect_Ref.write(false)(runningRef)();
                                    return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Completed.value)();
                                }
                            })();
                            return Hylograph_Transition_Coordinator.start(c)();
                        })();
                    };
                },
                getNodes: Hylograph_ForceEngine_Simulation.getNodes(sim),
                getAlpha: Effect_Ref.read(alphaRef),
                stop: function __do() {
                    var running = Effect_Ref.read(runningRef)();
                    return when(running)(function __do() {
                        Effect_Ref.write(false)(runningRef)();
                        return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Stopped.value)();
                    })();
                },
                start: function __do() {
                    var running = Effect_Ref.read(runningRef)();
                    return unless(running)(function __do() {
                        Hylograph_ForceEngine_Simulation.reheat(sim)();
                        Effect_Ref.write(1.0)(alphaRef)();
                        Effect_Ref.write(true)(runningRef)();
                        Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Started.value)();
                        var oldCoord = Effect_Ref.read(coordRef)();
                        Hylograph_Transition_Coordinator.stop(oldCoord)();
                        var c = Hylograph_Transition_Coordinator.create();
                        Effect_Ref.write(c)(coordRef)();
                        Hylograph_Transition_Coordinator.register(c)({
                            tick: d3Consumer(sim)(v.handle)(alphaRef)(config.alphaMin),
                            onComplete: function __do() {
                                Effect_Ref.write(false)(runningRef)();
                                return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Completed.value)();
                            }
                        })();
                        return Hylograph_Transition_Coordinator.start(c)();
                    })();
                },
                reheat: function __do() {
                    Hylograph_ForceEngine_Simulation.reheat(sim)();
                    Effect_Ref.write(1.0)(alphaRef)();
                    return Hylograph_Simulation_Emitter.emit(v.handle)(Hylograph_Simulation_Emitter.Started.value)();
                },
                interpolatePositions: function (startPos) {
                    return function (targetPos) {
                        return function (progress) {
                            return Hylograph_ForceEngine_Simulation.interpolatePositionsInPlace(startPos)(targetPos)(progress)(sim);
                        };
                    };
                },
                pinNodes: Hylograph_ForceEngine_Simulation.pinNodesInPlace(sim),
                unpinNodes: Hylograph_ForceEngine_Simulation.unpinNodesInPlace(sim)
            }
        };
    };
};
var runSimulation = function (config) {
    if (config.engine instanceof D3) {
        return runD3Simulation(config);
    };
    if (config.engine instanceof WASM) {
        return runWASMSimulation(config);
    };
    throw new Error("Failed pattern match at Hylograph.Simulation (line 230, column 24 - line 232, column 35): " + [ config.engine.constructor.name ]);
};
export {
    runSimulation,
    D3,
    WASM,
    initWASM
};
export {
    center,
    collide,
    dynamic,
    link,
    manyBody,
    positionX,
    positionY,
    radial,
    setup,
    static,
    withDistance,
    withDistanceMax,
    withDistanceMin,
    withFilter,
    withIterations,
    withRadius,
    withStrength,
    withTheta,
    withX,
    withY
} from "../Hylograph.ForceEngine.Setup/index.js";
export {
    Completed,
    Started,
    Stopped,
    Tick,
    subscribe
} from "../Hylograph.Simulation.Emitter/index.js";
//# sourceMappingURL=index.js.map
