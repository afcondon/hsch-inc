// Generated by purs version 0.15.15
import * as Affjax from "../Affjax/index.js";
import * as Affjax_ResponseFormat from "../Affjax.ResponseFormat/index.js";
import * as Affjax_StatusCode from "../Affjax.StatusCode/index.js";
import * as Affjax_Web from "../Affjax.Web/index.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_State_Class from "../Control.Monad.State.Class/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Aff_Class from "../Effect.Aff.Class/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Halogen_Component from "../Halogen.Component/index.js";
import * as Halogen_HTML from "../Halogen.HTML/index.js";
import * as Halogen_HTML_Core from "../Halogen.HTML.Core/index.js";
import * as Halogen_HTML_Elements from "../Halogen.HTML.Elements/index.js";
import * as Halogen_HTML_Properties from "../Halogen.HTML.Properties/index.js";
import * as Halogen_Query_HalogenM from "../Halogen.Query.HalogenM/index.js";
import * as Html_Renderer_Halogen from "../Html.Renderer.Halogen/index.js";
import * as Hylographic_Blog_ContentParser from "../Hylographic.Blog.ContentParser/index.js";
import * as Hylographic_Blog_Markdown from "../Hylographic.Blog.Markdown/index.js";
import * as Hylographic_Viz_Registry from "../Hylographic.Viz.Registry/index.js";
import * as Type_Proxy from "../Type.Proxy/index.js";
var bind = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect_Aff.applicativeAff);
var greaterThanOrEq = /* #__PURE__ */ Data_Ord.greaterThanOrEq(Affjax_StatusCode.ordStatusCode);
var lessThan = /* #__PURE__ */ Data_Ord.lessThan(Affjax_StatusCode.ordStatusCode);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var bind1 = /* #__PURE__ */ Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM);
var gets = /* #__PURE__ */ Control_Monad_State_Class.gets(Halogen_Query_HalogenM.monadStateHalogenM);
var modify_ = /* #__PURE__ */ Control_Monad_State_Class.modify_(Halogen_Query_HalogenM.monadStateHalogenM);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM);
var slot_ = /* #__PURE__ */ Halogen_HTML.slot_()({
    reflectSymbol: function () {
        return "viz";
    }
})(Data_Ord.ordInt);
var show1 = /* #__PURE__ */ Data_Show.show(/* #__PURE__ */ Data_Show.showArray(Data_Show.showString));
var Loading = /* #__PURE__ */ (function () {
    function Loading() {

    };
    Loading.value = new Loading();
    return Loading;
})();
var Loaded = /* #__PURE__ */ (function () {
    function Loaded(value0) {
        this.value0 = value0;
    };
    Loaded.create = function (value0) {
        return new Loaded(value0);
    };
    return Loaded;
})();
var $$Error = /* #__PURE__ */ (function () {
    function $$Error(value0) {
        this.value0 = value0;
    };
    $$Error.create = function (value0) {
        return new $$Error(value0);
    };
    return $$Error;
})();
var Initialize = /* #__PURE__ */ (function () {
    function Initialize() {

    };
    Initialize.value = new Initialize();
    return Initialize;
})();
var FetchComplete = /* #__PURE__ */ (function () {
    function FetchComplete(value0) {
        this.value0 = value0;
    };
    FetchComplete.create = function (value0) {
        return new FetchComplete(value0);
    };
    return FetchComplete;
})();
var initialState = function (slug) {
    return {
        slug: slug,
        content: Loading.value
    };
};
var fetchMarkdown = function (slug) {
    var url = "/blog/posts/" + (slug + ".md");
    return bind(Affjax_Web.get(Affjax_ResponseFormat.string)(url))(function (response) {
        if (response instanceof Data_Either.Left) {
            return pure(new Data_Either.Left("Failed to fetch: " + Affjax.printError(response.value0)));
        };
        if (response instanceof Data_Either.Right) {
            var $35 = greaterThanOrEq(response.value0.status)(200) && lessThan(response.value0.status)(300);
            if ($35) {
                return pure(new Data_Either.Right(response.value0.body));
            };
            return pure(new Data_Either.Left("HTTP " + (show(response.value0.status) + ": Article not found")));
        };
        throw new Error("Failed pattern match at Hylographic.Blog.ArticleViewer (line 148, column 3 - line 155, column 73): " + [ response.constructor.name ]);
    });
};
var handleAction = function (dictMonadAff) {
    var liftAff = Effect_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(dictMonadAff));
    var liftEffect = Effect_Class.liftEffect(Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff.MonadEffect0()));
    return function (v) {
        if (v instanceof Initialize) {
            return bind1(gets(function (v1) {
                return v1.slug;
            }))(function (slug) {
                return bind1(liftAff(fetchMarkdown(slug)))(function (result) {
                    return handleAction(dictMonadAff)(new FetchComplete(result));
                });
            });
        };
        if (v instanceof FetchComplete) {
            if (v.value0 instanceof Data_Either.Left) {
                return modify_(function (v1) {
                    var $40 = {};
                    for (var $41 in v1) {
                        if ({}.hasOwnProperty.call(v1, $41)) {
                            $40[$41] = v1[$41];
                        };
                    };
                    $40.content = new $$Error(v.value0.value0);
                    return $40;
                });
            };
            if (v.value0 instanceof Data_Either.Right) {
                var html = Hylographic_Blog_Markdown.parseMarkdown(v.value0.value0);
                var segments = Hylographic_Blog_ContentParser.parseContent(html);
                return discard(modify_(function (v1) {
                    var $44 = {};
                    for (var $45 in v1) {
                        if ({}.hasOwnProperty.call(v1, $45)) {
                            $44[$45] = v1[$45];
                        };
                    };
                    $44.content = new Loaded(segments);
                    return $44;
                }))(function () {
                    return liftEffect(Hylographic_Blog_Markdown.highlightElement("#article-content"));
                });
            };
            throw new Error("Failed pattern match at Hylographic.Blog.ArticleViewer (line 132, column 5 - line 141, column 59): " + [ v.value0.constructor.name ]);
        };
        throw new Error("Failed pattern match at Hylographic.Blog.ArticleViewer (line 124, column 16 - line 141, column 59): " + [ v.constructor.name ]);
    };
};
var _viz = /* #__PURE__ */ (function () {
    return Type_Proxy["Proxy"].value;
})();
var renderSegment = function (idx) {
    return function (v) {
        if (v instanceof Hylographic_Blog_ContentParser.HtmlContent) {
            return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.classes([ "article__html-segment" ]) ])([ Html_Renderer_Halogen.render_(v.value0) ]);
        };
        if (v instanceof Hylographic_Blog_ContentParser.VizComponent) {
            var v1 = Hylographic_Viz_Registry.lookupViz(v.value0);
            if (v1 instanceof Data_Maybe.Just) {
                return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.classes([ "article__viz-segment", "viz-" + v.value0 ]) ])([ slot_(_viz)(idx)(v1.value0)(Data_Unit.unit) ]);
            };
            if (v1 instanceof Data_Maybe.Nothing) {
                return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.classes([ "article__viz-error" ]) ])([ Halogen_HTML_Elements.p_([ Halogen_HTML_Core.text("Unknown visualization: " + v.value0), Halogen_HTML_Elements.br_, Halogen_HTML_Core.text("Available: " + show1(Hylographic_Viz_Registry.availableVizNames)) ]) ]);
            };
            throw new Error("Failed pattern match at Hylographic.Blog.ArticleViewer (line 108, column 5 - line 121, column 12): " + [ v1.constructor.name ]);
        };
        throw new Error("Failed pattern match at Hylographic.Blog.ArticleViewer (line 101, column 21 - line 121, column 12): " + [ v.constructor.name ]);
    };
};
var renderContent = function (v) {
    if (v instanceof Loading) {
        return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.classes([ "article__loading" ]) ])([ Halogen_HTML_Core.text("Loading article...") ]);
    };
    if (v instanceof Loaded) {
        return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.classes([ "article__content" ]), Halogen_HTML_Properties.id("article-content") ])(Data_Array.mapWithIndex(renderSegment)(v.value0));
    };
    if (v instanceof $$Error) {
        return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.classes([ "article__error" ]) ])([ Halogen_HTML_Elements.h2_([ Halogen_HTML_Core.text("Error loading article") ]), Halogen_HTML_Elements.p_([ Halogen_HTML_Core.text(v.value0) ]) ]);
    };
    throw new Error("Failed pattern match at Hylographic.Blog.ArticleViewer (line 79, column 17 - line 97, column 8): " + [ v.constructor.name ]);
};
var render = function (state) {
    return Halogen_HTML_Elements.article([ Halogen_HTML_Properties.classes([ "article" ]) ])([ renderContent(state.content) ]);
};
var component = /* #__PURE__ */ (function () {
    return Halogen_Component.mkComponent({
        initialState: initialState,
        render: render,
        "eval": Halogen_Component.mkEval({
            handleQuery: Halogen_Component.defaultEval.handleQuery,
            receive: Halogen_Component.defaultEval.receive,
            finalize: Halogen_Component.defaultEval.finalize,
            handleAction: handleAction(Effect_Aff_Class.monadAffAff),
            initialize: new Data_Maybe.Just(Initialize.value)
        })
    });
})();
export {
    Loading,
    Loaded,
    $$Error as Error,
    Initialize,
    FetchComplete,
    _viz,
    component,
    initialState,
    render,
    renderContent,
    renderSegment,
    handleAction,
    fetchMarkdown
};
//# sourceMappingURL=index.js.map
